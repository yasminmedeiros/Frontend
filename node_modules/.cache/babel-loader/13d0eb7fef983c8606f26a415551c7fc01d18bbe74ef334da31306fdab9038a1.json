{"ast":null,"code":"/**\n* Copyright 2012-2019, Plotly, Inc.\n* All rights reserved.\n*\n* This source code is licensed under the MIT license found in the\n* LICENSE file in the root directory of this source tree.\n*/\n\n'use strict';\n\nvar d3 = require('d3');\nvar Plotly = require('../../plot_api/plot_api');\nvar Fx = require('../../components/fx');\nvar Lib = require('../../lib');\nvar Drawing = require('../../components/drawing');\nvar tinycolor = require('tinycolor2');\nvar svgTextUtils = require('../../lib/svg_text_utils');\nfunction performPlot(parcatsModels, graphDiv, layout, svg) {\n  var viewModels = parcatsModels.map(createParcatsViewModel.bind(0, graphDiv, layout));\n\n  // Get (potentially empty) parcatslayer selection with bound data to single element array\n  var layerSelection = svg.selectAll('g.parcatslayer').data([null]);\n\n  // Initialize single parcatslayer group if it doesn't exist\n  layerSelection.enter().append('g').attr('class', 'parcatslayer').style('pointer-events', 'all');\n\n  // Bind data to children of layerSelection and get reference to traceSelection\n  var traceSelection = layerSelection.selectAll('g.trace.parcats').data(viewModels, key);\n\n  // Initialize group for each trace/dimensions\n  var traceEnter = traceSelection.enter().append('g').attr('class', 'trace parcats');\n\n  // Update properties for each trace\n  traceSelection.attr('transform', function (d) {\n    return 'translate(' + d.x + ', ' + d.y + ')';\n  });\n\n  // Initialize paths group\n  traceEnter.append('g').attr('class', 'paths');\n\n  // Update paths transform\n  var pathsSelection = traceSelection.select('g.paths');\n\n  // Get paths selection\n  var pathSelection = pathsSelection.selectAll('path.path').data(function (d) {\n    return d.paths;\n  }, key);\n\n  // Update existing path colors\n  pathSelection.attr('fill', function (d) {\n    return d.model.color;\n  });\n\n  // Create paths\n  var pathSelectionEnter = pathSelection.enter().append('path').attr('class', 'path').attr('stroke-opacity', 0).attr('fill', function (d) {\n    return d.model.color;\n  }).attr('fill-opacity', 0);\n  stylePathsNoHover(pathSelectionEnter);\n\n  // Set path geometry\n  pathSelection.attr('d', function (d) {\n    return d.svgD;\n  });\n\n  // sort paths\n  if (!pathSelectionEnter.empty()) {\n    // Only sort paths if there has been a change.\n    // Otherwise paths are already sorted or a hover operation may be in progress\n    pathSelection.sort(compareRawColor);\n  }\n\n  // Remove any old paths\n  pathSelection.exit().remove();\n\n  // Path hover\n  pathSelection.on('mouseover', mouseoverPath).on('mouseout', mouseoutPath).on('click', clickPath);\n\n  // Initialize dimensions group\n  traceEnter.append('g').attr('class', 'dimensions');\n\n  // Update dimensions transform\n  var dimensionsSelection = traceSelection.select('g.dimensions');\n\n  // Get dimension selection\n  var dimensionSelection = dimensionsSelection.selectAll('g.dimension').data(function (d) {\n    return d.dimensions;\n  }, key);\n\n  // Create dimension groups\n  dimensionSelection.enter().append('g').attr('class', 'dimension');\n\n  // Update dimension group transforms\n  dimensionSelection.attr('transform', function (d) {\n    return 'translate(' + d.x + ', 0)';\n  });\n\n  // Remove any old dimensions\n  dimensionSelection.exit().remove();\n\n  // Get category selection\n  var categorySelection = dimensionSelection.selectAll('g.category').data(function (d) {\n    return d.categories;\n  }, key);\n\n  // Initialize category groups\n  var categoryGroupEnterSelection = categorySelection.enter().append('g').attr('class', 'category');\n\n  // Update category transforms\n  categorySelection.attr('transform', function (d) {\n    return 'translate(0, ' + d.y + ')';\n  });\n\n  // Initialize rectangle\n  categoryGroupEnterSelection.append('rect').attr('class', 'catrect').attr('pointer-events', 'none');\n\n  // Update rectangle\n  categorySelection.select('rect.catrect').attr('fill', 'none').attr('width', function (d) {\n    return d.width;\n  }).attr('height', function (d) {\n    return d.height;\n  });\n  styleCategoriesNoHover(categoryGroupEnterSelection);\n\n  // Initialize color band rects\n  var bandSelection = categorySelection.selectAll('rect.bandrect').data( /** @param {CategoryViewModel} catViewModel*/\n  function (catViewModel) {\n    return catViewModel.bands;\n  }, key);\n\n  // Raise all update bands to the top so that fading enter/exit bands will be behind\n  bandSelection.each(function () {\n    Lib.raiseToTop(this);\n  });\n\n  // Update band color\n  bandSelection.attr('fill', function (d) {\n    return d.color;\n  });\n  var bandsSelectionEnter = bandSelection.enter().append('rect').attr('class', 'bandrect').attr('stroke-opacity', 0).attr('fill', function (d) {\n    return d.color;\n  }).attr('fill-opacity', 0);\n  bandSelection.attr('fill', function (d) {\n    return d.color;\n  }).attr('width', function (d) {\n    return d.width;\n  }).attr('height', function (d) {\n    return d.height;\n  }).attr('y', function (d) {\n    return d.y;\n  }).attr('cursor', /** @param {CategoryBandViewModel} bandModel*/\n  function (bandModel) {\n    if (bandModel.parcatsViewModel.arrangement === 'fixed') {\n      return 'default';\n    } else if (bandModel.parcatsViewModel.arrangement === 'perpendicular') {\n      return 'ns-resize';\n    } else {\n      return 'move';\n    }\n  });\n  styleBandsNoHover(bandsSelectionEnter);\n  bandSelection.exit().remove();\n\n  // Initialize category label\n  categoryGroupEnterSelection.append('text').attr('class', 'catlabel').attr('pointer-events', 'none');\n  var paperColor = graphDiv._fullLayout.paper_bgcolor;\n\n  // Update category label\n  categorySelection.select('text.catlabel').attr('text-anchor', function (d) {\n    if (catInRightDim(d)) {\n      // Place label to the right of category\n      return 'start';\n    } else {\n      // Place label to the left of category\n      return 'end';\n    }\n  }).attr('alignment-baseline', 'middle').style('text-shadow', paperColor + ' -1px  1px 2px, ' + paperColor + ' 1px  1px 2px, ' + paperColor + '  1px -1px 2px, ' + paperColor + ' -1px -1px 2px').style('fill', 'rgb(0, 0, 0)').attr('x', function (d) {\n    if (catInRightDim(d)) {\n      // Place label to the right of category\n      return d.width + 5;\n    } else {\n      // Place label to the left of category\n      return -5;\n    }\n  }).attr('y', function (d) {\n    return d.height / 2;\n  }).text(function (d) {\n    return d.model.categoryLabel;\n  }).each( /** @param {CategoryViewModel} catModel*/\n  function (catModel) {\n    Drawing.font(d3.select(this), catModel.parcatsViewModel.categorylabelfont);\n    svgTextUtils.convertToTspans(d3.select(this), graphDiv);\n  });\n\n  // Initialize dimension label\n  categoryGroupEnterSelection.append('text').attr('class', 'dimlabel');\n\n  // Update dimension label\n  categorySelection.select('text.dimlabel').attr('text-anchor', 'middle').attr('alignment-baseline', 'baseline').attr('cursor', /** @param {CategoryViewModel} catModel*/\n  function (catModel) {\n    if (catModel.parcatsViewModel.arrangement === 'fixed') {\n      return 'default';\n    } else {\n      return 'ew-resize';\n    }\n  }).attr('x', function (d) {\n    return d.width / 2;\n  }).attr('y', -5).text(function (d, i) {\n    if (i === 0) {\n      // Add dimension label above topmost category\n      return d.parcatsViewModel.model.dimensions[d.model.dimensionInd].dimensionLabel;\n    } else {\n      return null;\n    }\n  }).each( /** @param {CategoryViewModel} catModel*/\n  function (catModel) {\n    Drawing.font(d3.select(this), catModel.parcatsViewModel.labelfont);\n  });\n\n  // Category hover\n  // categorySelection.select('rect.catrect')\n  categorySelection.selectAll('rect.bandrect').on('mouseover', mouseoverCategoryBand).on('mouseout', mouseoutCategory);\n\n  // Remove unused categories\n  categorySelection.exit().remove();\n\n  // Setup drag\n  dimensionSelection.call(d3.behavior.drag().origin(function (d) {\n    return {\n      x: d.x,\n      y: 0\n    };\n  }).on('dragstart', dragDimensionStart).on('drag', dragDimension).on('dragend', dragDimensionEnd));\n\n  // Save off selections to view models\n  traceSelection.each(function (d) {\n    d.traceSelection = d3.select(this);\n    d.pathSelection = d3.select(this).selectAll('g.paths').selectAll('path.path');\n    d.dimensionSelection = d3.select(this).selectAll('g.dimensions').selectAll('g.dimension');\n  });\n\n  // Remove any orphan traces\n  traceSelection.exit().remove();\n}\n\n/**\n * Create / update parcat traces\n *\n * @param {Object} graphDiv\n * @param {Object} svg\n * @param {Array.<ParcatsModel>} parcatsModels\n * @param {Layout} layout\n */\nmodule.exports = function (graphDiv, svg, parcatsModels, layout) {\n  performPlot(parcatsModels, graphDiv, layout, svg);\n};\n\n/**\n * Function the returns the key property of an object for use with as D3 join function\n * @param d\n */\nfunction key(d) {\n  return d.key;\n}\n\n/** True if a category view model is in the right-most display dimension\n * @param {CategoryViewModel} d */\nfunction catInRightDim(d) {\n  var numDims = d.parcatsViewModel.dimensions.length;\n  var leftDimInd = d.parcatsViewModel.dimensions[numDims - 1].model.dimensionInd;\n  return d.model.dimensionInd === leftDimInd;\n}\n\n/**\n * @param {PathViewModel} a\n * @param {PathViewModel} b\n */\nfunction compareRawColor(a, b) {\n  if (a.model.rawColor > b.model.rawColor) {\n    return 1;\n  } else if (a.model.rawColor < b.model.rawColor) {\n    return -1;\n  } else {\n    return 0;\n  }\n}\n\n/**\n * Handle path mouseover\n * @param {PathViewModel} d\n */\nfunction mouseoverPath(d) {\n  if (!d.parcatsViewModel.dragDimension) {\n    // We're not currently dragging\n\n    if (d.parcatsViewModel.hoverinfoItems.indexOf('skip') === -1) {\n      // hoverinfo is not skip, so we at least style the paths and emit interaction events\n\n      // Raise path to top\n      Lib.raiseToTop(this);\n      stylePathsHover(d3.select(this));\n\n      // Emit hover event\n      var points = buildPointsArrayForPath(d);\n      d.parcatsViewModel.graphDiv.emit('plotly_hover', {\n        points: points,\n        event: d3.event\n      });\n\n      // Handle hover label\n      if (d.parcatsViewModel.hoverinfoItems.indexOf('none') === -1) {\n        // hoverinfo is a combination of 'count' and 'probability'\n\n        // Mouse\n        var hoverX = d3.mouse(this)[0];\n\n        // Label\n        var gd = d.parcatsViewModel.graphDiv;\n        var fullLayout = gd._fullLayout;\n        var rootBBox = fullLayout._paperdiv.node().getBoundingClientRect();\n        var graphDivBBox = d.parcatsViewModel.graphDiv.getBoundingClientRect();\n\n        // Find path center in path coordinates\n        var pathCenterX, pathCenterY, dimInd;\n        for (dimInd = 0; dimInd < d.leftXs.length - 1; dimInd++) {\n          if (d.leftXs[dimInd] + d.dimWidths[dimInd] - 2 <= hoverX && hoverX <= d.leftXs[dimInd + 1] + 2) {\n            var leftDim = d.parcatsViewModel.dimensions[dimInd];\n            var rightDim = d.parcatsViewModel.dimensions[dimInd + 1];\n            pathCenterX = (leftDim.x + leftDim.width + rightDim.x) / 2;\n            pathCenterY = (d.topYs[dimInd] + d.topYs[dimInd + 1] + d.height) / 2;\n            break;\n          }\n        }\n\n        // Find path center in root coordinates\n        var hoverCenterX = d.parcatsViewModel.x + pathCenterX;\n        var hoverCenterY = d.parcatsViewModel.y + pathCenterY;\n        var textColor = tinycolor.mostReadable(d.model.color, ['black', 'white']);\n\n        // Build hover text\n        var hovertextParts = [];\n        if (d.parcatsViewModel.hoverinfoItems.indexOf('count') !== -1) {\n          hovertextParts.push(['Count:', d.model.count].join(' '));\n        }\n        if (d.parcatsViewModel.hoverinfoItems.indexOf('probability') !== -1) {\n          hovertextParts.push(['P:', (d.model.count / d.parcatsViewModel.model.count).toFixed(3)].join(' '));\n        }\n        var hovertext = hovertextParts.join('<br>');\n        var mouseX = d3.mouse(gd)[0];\n        Fx.loneHover({\n          x: hoverCenterX - rootBBox.left + graphDivBBox.left,\n          y: hoverCenterY - rootBBox.top + graphDivBBox.top,\n          text: hovertext,\n          color: d.model.color,\n          borderColor: 'black',\n          fontFamily: 'Monaco, \"Courier New\", monospace',\n          fontSize: 10,\n          fontColor: textColor,\n          idealAlign: mouseX < hoverCenterX ? 'right' : 'left'\n        }, {\n          container: fullLayout._hoverlayer.node(),\n          outerContainer: fullLayout._paper.node(),\n          gd: gd\n        });\n      }\n    }\n  }\n}\n\n/**\n * Handle path mouseout\n * @param {PathViewModel} d\n */\nfunction mouseoutPath(d) {\n  if (!d.parcatsViewModel.dragDimension) {\n    // We're not currently dragging\n    stylePathsNoHover(d3.select(this));\n\n    // Remove and hover label\n    Fx.loneUnhover(d.parcatsViewModel.graphDiv._fullLayout._hoverlayer.node());\n\n    // Restore path order\n    d.parcatsViewModel.pathSelection.sort(compareRawColor);\n\n    // Emit unhover event\n    if (d.parcatsViewModel.hoverinfoItems.indexOf('skip') === -1) {\n      var points = buildPointsArrayForPath(d);\n      d.parcatsViewModel.graphDiv.emit('plotly_unhover', {\n        points: points,\n        event: d3.event\n      });\n    }\n  }\n}\n\n/**\n * Build array of point objects for a path\n *\n * For use in click/hover events\n * @param {PathViewModel} d\n */\nfunction buildPointsArrayForPath(d) {\n  var points = [];\n  var curveNumber = getTraceIndex(d.parcatsViewModel);\n  for (var i = 0; i < d.model.valueInds.length; i++) {\n    var pointNumber = d.model.valueInds[i];\n    points.push({\n      curveNumber: curveNumber,\n      pointNumber: pointNumber\n    });\n  }\n  return points;\n}\n\n/**\n * Handle path click\n * @param {PathViewModel} d\n */\nfunction clickPath(d) {\n  if (d.parcatsViewModel.hoverinfoItems.indexOf('skip') === -1) {\n    // hoverinfo it's skip, so interaction events aren't disabled\n    var points = buildPointsArrayForPath(d);\n    d.parcatsViewModel.graphDiv.emit('plotly_click', {\n      points: points,\n      event: d3.event\n    });\n  }\n}\nfunction stylePathsNoHover(pathSelection) {\n  pathSelection.attr('fill', function (d) {\n    return d.model.color;\n  }).attr('fill-opacity', 0.6).attr('stroke', 'lightgray').attr('stroke-width', 0.2).attr('stroke-opacity', 1.0);\n}\nfunction stylePathsHover(pathSelection) {\n  pathSelection.attr('fill-opacity', 0.8).attr('stroke', function (d) {\n    return tinycolor.mostReadable(d.model.color, ['black', 'white']);\n  }).attr('stroke-width', 0.3);\n}\nfunction styleCategoryHover(categorySelection) {\n  categorySelection.select('rect.catrect').attr('stroke', 'black').attr('stroke-width', 2.5);\n}\nfunction styleCategoriesNoHover(categorySelection) {\n  categorySelection.select('rect.catrect').attr('stroke', 'black').attr('stroke-width', 1).attr('stroke-opacity', 1);\n}\nfunction styleBandsHover(bandsSelection) {\n  bandsSelection.attr('stroke', 'black').attr('stroke-width', 1.5);\n}\nfunction styleBandsNoHover(bandsSelection) {\n  bandsSelection.attr('stroke', 'black').attr('stroke-width', 0.2).attr('stroke-opacity', 1.0).attr('fill-opacity', 1.0);\n}\n\n/**\n * Return selection of all paths that pass through the specified category\n * @param {CategoryBandViewModel} catBandViewModel\n */\nfunction selectPathsThroughCategoryBandColor(catBandViewModel) {\n  var allPaths = catBandViewModel.parcatsViewModel.pathSelection;\n  var dimInd = catBandViewModel.categoryViewModel.model.dimensionInd;\n  var catInd = catBandViewModel.categoryViewModel.model.categoryInd;\n  return allPaths.filter( /** @param {PathViewModel} pathViewModel */\n  function (pathViewModel) {\n    return pathViewModel.model.categoryInds[dimInd] === catInd && pathViewModel.model.color === catBandViewModel.color;\n  });\n}\n\n/**\n * Perform hover styling for all paths that pass though the specified band element's category\n *\n * @param {HTMLElement} bandElement\n *  HTML element for band\n *\n */\nfunction styleForCategoryHovermode(bandElement) {\n  // Get all bands in the current category\n  var bandSel = d3.select(bandElement.parentNode).selectAll('rect.bandrect');\n\n  // Raise and style paths\n  bandSel.each(function (bvm) {\n    var paths = selectPathsThroughCategoryBandColor(bvm);\n    stylePathsHover(paths);\n    paths.each(function () {\n      // Raise path to top\n      Lib.raiseToTop(this);\n    });\n  });\n\n  // Style category\n  styleCategoryHover(d3.select(bandElement.parentNode));\n}\n\n/**\n * Perform hover styling for all paths that pass though the category of the specified band element and share the\n * same color\n *\n * @param {HTMLElement} bandElement\n *  HTML element for band\n *\n */\nfunction styleForColorHovermode(bandElement) {\n  var bandViewModel = d3.select(bandElement).datum();\n  var catPaths = selectPathsThroughCategoryBandColor(bandViewModel);\n  stylePathsHover(catPaths);\n  catPaths.each(function () {\n    // Raise path to top\n    Lib.raiseToTop(this);\n  });\n\n  // Style category for drag\n  d3.select(bandElement.parentNode).selectAll('rect.bandrect').filter(function (b) {\n    return b.color === bandViewModel.color;\n  }).each(function () {\n    Lib.raiseToTop(this);\n    styleBandsHover(d3.select(this));\n  });\n}\n\n/**\n * @param {HTMLElement} bandElement\n *  HTML element for band\n * @param eventName\n *  Event name (plotly_hover or plotly_click)\n * @param event\n *  Mouse Event\n */\nfunction emitPointsEventCategoryHovermode(bandElement, eventName, event) {\n  // Get all bands in the current category\n  var bandViewModel = d3.select(bandElement).datum();\n  var gd = bandViewModel.parcatsViewModel.graphDiv;\n  var bandSel = d3.select(bandElement.parentNode).selectAll('rect.bandrect');\n  var points = [];\n  bandSel.each(function (bvm) {\n    var paths = selectPathsThroughCategoryBandColor(bvm);\n    paths.each(function (pathViewModel) {\n      // Extend points array\n      Array.prototype.push.apply(points, buildPointsArrayForPath(pathViewModel));\n    });\n  });\n  gd.emit(eventName, {\n    points: points,\n    event: event\n  });\n}\n\n/**\n * @param {HTMLElement} bandElement\n *  HTML element for band\n * @param eventName\n *  Event name (plotly_hover or plotly_click)\n * @param event\n *  Mouse Event\n */\nfunction emitPointsEventColorHovermode(bandElement, eventName, event) {\n  var bandViewModel = d3.select(bandElement).datum();\n  var gd = bandViewModel.parcatsViewModel.graphDiv;\n  var paths = selectPathsThroughCategoryBandColor(bandViewModel);\n  var points = [];\n  paths.each(function (pathViewModel) {\n    // Extend points array\n    Array.prototype.push.apply(points, buildPointsArrayForPath(pathViewModel));\n  });\n  gd.emit(eventName, {\n    points: points,\n    event: event\n  });\n}\n\n/**\n * Create hover label for a band element's category (for use when hoveron === 'category')\n *\n * @param {ClientRect} rootBBox\n *  Client bounding box for root of figure\n * @param {HTMLElement} bandElement\n *  HTML element for band\n *\n */\nfunction createHoverLabelForCategoryHovermode(rootBBox, bandElement) {\n  // Selections\n  var rectSelection = d3.select(bandElement.parentNode).select('rect.catrect');\n  var rectBoundingBox = rectSelection.node().getBoundingClientRect();\n\n  // Models\n  /** @type {CategoryViewModel} */\n  var catViewModel = rectSelection.datum();\n  var parcatsViewModel = catViewModel.parcatsViewModel;\n  var dimensionModel = parcatsViewModel.model.dimensions[catViewModel.model.dimensionInd];\n\n  // Positions\n  var hoverCenterY = rectBoundingBox.top + rectBoundingBox.height / 2;\n  var hoverCenterX, hoverLabelIdealAlign;\n  if (parcatsViewModel.dimensions.length > 1 && dimensionModel.displayInd === parcatsViewModel.dimensions.length - 1) {\n    // right most dimension\n    hoverCenterX = rectBoundingBox.left;\n    hoverLabelIdealAlign = 'left';\n  } else {\n    hoverCenterX = rectBoundingBox.left + rectBoundingBox.width;\n    hoverLabelIdealAlign = 'right';\n  }\n\n  // Hover label text\n  var hoverinfoParts = [];\n  if (catViewModel.parcatsViewModel.hoverinfoItems.indexOf('count') !== -1) {\n    hoverinfoParts.push(['Count:', catViewModel.model.count].join(' '));\n  }\n  if (catViewModel.parcatsViewModel.hoverinfoItems.indexOf('probability') !== -1) {\n    hoverinfoParts.push(['P(' + catViewModel.model.categoryLabel + '):', (catViewModel.model.count / catViewModel.parcatsViewModel.model.count).toFixed(3)].join(' '));\n  }\n  var hovertext = hoverinfoParts.join('<br>');\n  return {\n    x: hoverCenterX - rootBBox.left,\n    y: hoverCenterY - rootBBox.top,\n    text: hovertext,\n    color: 'lightgray',\n    borderColor: 'black',\n    fontFamily: 'Monaco, \"Courier New\", monospace',\n    fontSize: 12,\n    fontColor: 'black',\n    idealAlign: hoverLabelIdealAlign\n  };\n}\n\n/**\n * Create hover label for a band element's category (for use when hoveron === 'category')\n *\n * @param {ClientRect} rootBBox\n *  Client bounding box for root of figure\n * @param {HTMLElement} bandElement\n *  HTML element for band\n *\n */\nfunction createHoverLabelForDimensionHovermode(rootBBox, bandElement) {\n  var allHoverlabels = [];\n  d3.select(bandElement.parentNode.parentNode).selectAll('g.category').select('rect.catrect').each(function () {\n    var bandNode = this;\n    allHoverlabels.push(createHoverLabelForCategoryHovermode(rootBBox, bandNode));\n  });\n  return allHoverlabels;\n}\n\n/**\n * Create hover labels for a band element's category (for use when hoveron === 'dimension')\n *\n * @param {ClientRect} rootBBox\n *  Client bounding box for root of figure\n * @param {HTMLElement} bandElement\n *  HTML element for band\n *\n */\nfunction createHoverLabelForColorHovermode(rootBBox, bandElement) {\n  var bandBoundingBox = bandElement.getBoundingClientRect();\n\n  // Models\n  /** @type {CategoryBandViewModel} */\n  var bandViewModel = d3.select(bandElement).datum();\n  var catViewModel = bandViewModel.categoryViewModel;\n  var parcatsViewModel = catViewModel.parcatsViewModel;\n  var dimensionModel = parcatsViewModel.model.dimensions[catViewModel.model.dimensionInd];\n\n  // positions\n  var hoverCenterY = bandBoundingBox.y + bandBoundingBox.height / 2;\n  var hoverCenterX, hoverLabelIdealAlign;\n  if (parcatsViewModel.dimensions.length > 1 && dimensionModel.displayInd === parcatsViewModel.dimensions.length - 1) {\n    // right most dimension\n    hoverCenterX = bandBoundingBox.left;\n    hoverLabelIdealAlign = 'left';\n  } else {\n    hoverCenterX = bandBoundingBox.left + bandBoundingBox.width;\n    hoverLabelIdealAlign = 'right';\n  }\n\n  // Labels\n  var catLabel = catViewModel.model.categoryLabel;\n\n  // Counts\n  var totalCount = bandViewModel.parcatsViewModel.model.count;\n  var bandColorCount = 0;\n  bandViewModel.categoryViewModel.bands.forEach(function (b) {\n    if (b.color === bandViewModel.color) {\n      bandColorCount += b.count;\n    }\n  });\n  var catCount = catViewModel.model.count;\n  var colorCount = 0;\n  parcatsViewModel.pathSelection.each( /** @param {PathViewModel} pathViewModel */\n  function (pathViewModel) {\n    if (pathViewModel.model.color === bandViewModel.color) {\n      colorCount += pathViewModel.model.count;\n    }\n  });\n\n  // Hover label text\n  var hoverinfoParts = [];\n  if (catViewModel.parcatsViewModel.hoverinfoItems.indexOf('count') !== -1) {\n    hoverinfoParts.push(['Count:', bandColorCount].join(' '));\n  }\n  if (catViewModel.parcatsViewModel.hoverinfoItems.indexOf('probability') !== -1) {\n    var pColorAndCatLable = 'P(color ∩ ' + catLabel + '): ';\n    var pColorAndCatValue = (bandColorCount / totalCount).toFixed(3);\n    var pColorAndCatRow = pColorAndCatLable + pColorAndCatValue;\n    hoverinfoParts.push(pColorAndCatRow);\n    var pCatGivenColorLabel = 'P(' + catLabel + ' | color): ';\n    var pCatGivenColorValue = (bandColorCount / colorCount).toFixed(3);\n    var pCatGivenColorRow = pCatGivenColorLabel + pCatGivenColorValue;\n    hoverinfoParts.push(pCatGivenColorRow);\n    var pColorGivenCatLabel = 'P(color | ' + catLabel + '): ';\n    var pColorGivenCatValue = (bandColorCount / catCount).toFixed(3);\n    var pColorGivenCatRow = pColorGivenCatLabel + pColorGivenCatValue;\n    hoverinfoParts.push(pColorGivenCatRow);\n  }\n  var hovertext = hoverinfoParts.join('<br>');\n\n  // Compute text color\n  var textColor = tinycolor.mostReadable(bandViewModel.color, ['black', 'white']);\n  return {\n    x: hoverCenterX - rootBBox.left,\n    y: hoverCenterY - rootBBox.top,\n    // name: 'NAME',\n    text: hovertext,\n    color: bandViewModel.color,\n    borderColor: 'black',\n    fontFamily: 'Monaco, \"Courier New\", monospace',\n    fontColor: textColor,\n    fontSize: 10,\n    idealAlign: hoverLabelIdealAlign\n  };\n}\n\n/**\n * Handle dimension mouseover\n * @param {CategoryBandViewModel} bandViewModel\n */\nfunction mouseoverCategoryBand(bandViewModel) {\n  if (!bandViewModel.parcatsViewModel.dragDimension) {\n    // We're not currently dragging\n\n    if (bandViewModel.parcatsViewModel.hoverinfoItems.indexOf('skip') === -1) {\n      // hoverinfo is not skip, so we at least style the bands and emit interaction events\n\n      // Mouse\n      var mouseY = d3.mouse(this)[1];\n      if (mouseY < -1) {\n        // Hover is above above the category rectangle (probably the dimension title text)\n        return;\n      }\n      var gd = bandViewModel.parcatsViewModel.graphDiv;\n      var fullLayout = gd._fullLayout;\n      var rootBBox = fullLayout._paperdiv.node().getBoundingClientRect();\n      var hoveron = bandViewModel.parcatsViewModel.hoveron;\n\n      /** @type {HTMLElement} */\n      var bandElement = this;\n\n      // Handle style and events\n      if (hoveron === 'color') {\n        styleForColorHovermode(bandElement);\n        emitPointsEventColorHovermode(bandElement, 'plotly_hover', d3.event);\n      } else {\n        styleForCategoryHovermode(bandElement);\n        emitPointsEventCategoryHovermode(bandElement, 'plotly_hover', d3.event);\n      }\n\n      // Handle hover label\n      if (bandViewModel.parcatsViewModel.hoverinfoItems.indexOf('none') === -1) {\n        var hoverItems;\n        if (hoveron === 'category') {\n          hoverItems = createHoverLabelForCategoryHovermode(rootBBox, bandElement);\n        } else if (hoveron === 'color') {\n          hoverItems = createHoverLabelForColorHovermode(rootBBox, bandElement);\n        } else if (hoveron === 'dimension') {\n          hoverItems = createHoverLabelForDimensionHovermode(rootBBox, bandElement);\n        }\n        if (hoverItems) {\n          Fx.multiHovers(hoverItems, {\n            container: fullLayout._hoverlayer.node(),\n            outerContainer: fullLayout._paper.node(),\n            gd: gd\n          });\n        }\n      }\n    }\n  }\n}\n\n/**\n * Handle dimension mouseover\n * @param {CategoryBandViewModel} bandViewModel\n */\nfunction mouseoutCategory(bandViewModel) {\n  var parcatsViewModel = bandViewModel.parcatsViewModel;\n  if (!parcatsViewModel.dragDimension) {\n    // We're not dragging anything\n\n    // Reset unhovered styles\n    stylePathsNoHover(parcatsViewModel.pathSelection);\n    styleCategoriesNoHover(parcatsViewModel.dimensionSelection.selectAll('g.category'));\n    styleBandsNoHover(parcatsViewModel.dimensionSelection.selectAll('g.category').selectAll('rect.bandrect'));\n\n    // Remove hover label\n    Fx.loneUnhover(parcatsViewModel.graphDiv._fullLayout._hoverlayer.node());\n\n    // Restore path order\n    parcatsViewModel.pathSelection.sort(compareRawColor);\n\n    // Emit unhover event\n    if (parcatsViewModel.hoverinfoItems.indexOf('skip') === -1) {\n      var hoveron = bandViewModel.parcatsViewModel.hoveron;\n      var bandElement = this;\n\n      // Handle style and events\n      if (hoveron === 'color') {\n        emitPointsEventColorHovermode(bandElement, 'plotly_unhover', d3.event);\n      } else {\n        emitPointsEventCategoryHovermode(bandElement, 'plotly_unhover', d3.event);\n      }\n    }\n  }\n}\n\n/**\n * Handle dimension drag start\n * @param {DimensionViewModel} d\n */\nfunction dragDimensionStart(d) {\n  // Check if dragging is supported\n  if (d.parcatsViewModel.arrangement === 'fixed') {\n    return;\n  }\n\n  // Save off initial drag indexes for dimension\n  d.dragDimensionDisplayInd = d.model.displayInd;\n  d.initialDragDimensionDisplayInds = d.parcatsViewModel.model.dimensions.map(function (d) {\n    return d.displayInd;\n  });\n  d.dragHasMoved = false;\n\n  // Check for category hit\n  d.dragCategoryDisplayInd = null;\n  d3.select(this).selectAll('g.category').select('rect.catrect').each( /** @param {CategoryViewModel} catViewModel */\n  function (catViewModel) {\n    var catMouseX = d3.mouse(this)[0];\n    var catMouseY = d3.mouse(this)[1];\n    if (-2 <= catMouseX && catMouseX <= catViewModel.width + 2 && -2 <= catMouseY && catMouseY <= catViewModel.height + 2) {\n      // Save off initial drag indexes for categories\n      d.dragCategoryDisplayInd = catViewModel.model.displayInd;\n      d.initialDragCategoryDisplayInds = d.model.categories.map(function (c) {\n        return c.displayInd;\n      });\n\n      // Initialize categories dragY to be the current y position\n      catViewModel.model.dragY = catViewModel.y;\n\n      // Raise category\n      Lib.raiseToTop(this.parentNode);\n\n      // Get band element\n      d3.select(this.parentNode).selectAll('rect.bandrect')\n      /** @param {CategoryBandViewModel} bandViewModel */.each(function (bandViewModel) {\n        if (bandViewModel.y < catMouseY && catMouseY <= bandViewModel.y + bandViewModel.height) {\n          d.potentialClickBand = this;\n        }\n      });\n    }\n  });\n\n  // Update toplevel drag dimension\n  d.parcatsViewModel.dragDimension = d;\n\n  // Remove hover label if any\n  Fx.loneUnhover(d.parcatsViewModel.graphDiv._fullLayout._hoverlayer.node());\n}\n\n/**\n * Handle dimension drag\n * @param {DimensionViewModel} d\n */\nfunction dragDimension(d) {\n  // Check if dragging is supported\n  if (d.parcatsViewModel.arrangement === 'fixed') {\n    return;\n  }\n  d.dragHasMoved = true;\n  if (d.dragDimensionDisplayInd === null) {\n    return;\n  }\n  var dragDimInd = d.dragDimensionDisplayInd;\n  var prevDimInd = dragDimInd - 1;\n  var nextDimInd = dragDimInd + 1;\n  var dragDimension = d.parcatsViewModel.dimensions[dragDimInd];\n\n  // Update category\n  if (d.dragCategoryDisplayInd !== null) {\n    var dragCategory = dragDimension.categories[d.dragCategoryDisplayInd];\n\n    // Update dragY by dy\n    dragCategory.model.dragY += d3.event.dy;\n    var categoryY = dragCategory.model.dragY;\n\n    // Check for category drag swaps\n    var catDisplayInd = dragCategory.model.displayInd;\n    var dimCategoryViews = dragDimension.categories;\n    var catAbove = dimCategoryViews[catDisplayInd - 1];\n    var catBelow = dimCategoryViews[catDisplayInd + 1];\n\n    // Check for overlap above\n    if (catAbove !== undefined) {\n      if (categoryY < catAbove.y + catAbove.height / 2.0) {\n        // Swap display inds\n        dragCategory.model.displayInd = catAbove.model.displayInd;\n        catAbove.model.displayInd = catDisplayInd;\n      }\n    }\n    if (catBelow !== undefined) {\n      if (categoryY + dragCategory.height > catBelow.y + catBelow.height / 2.0) {\n        // Swap display inds\n        dragCategory.model.displayInd = catBelow.model.displayInd;\n        catBelow.model.displayInd = catDisplayInd;\n      }\n    }\n\n    // Update category drag display index\n    d.dragCategoryDisplayInd = dragCategory.model.displayInd;\n  }\n\n  // Update dimension position\n  if (d.dragCategoryDisplayInd === null || d.parcatsViewModel.arrangement === 'freeform') {\n    dragDimension.model.dragX = d3.event.x;\n\n    // Check for dimension swaps\n    var prevDimension = d.parcatsViewModel.dimensions[prevDimInd];\n    var nextDimension = d.parcatsViewModel.dimensions[nextDimInd];\n    if (prevDimension !== undefined) {\n      if (dragDimension.model.dragX < prevDimension.x + prevDimension.width) {\n        // Swap display inds\n        dragDimension.model.displayInd = prevDimension.model.displayInd;\n        prevDimension.model.displayInd = dragDimInd;\n      }\n    }\n    if (nextDimension !== undefined) {\n      if (dragDimension.model.dragX + dragDimension.width > nextDimension.x) {\n        // Swap display inds\n        dragDimension.model.displayInd = nextDimension.model.displayInd;\n        nextDimension.model.displayInd = d.dragDimensionDisplayInd;\n      }\n    }\n\n    // Update drag display index\n    d.dragDimensionDisplayInd = dragDimension.model.displayInd;\n  }\n\n  // Update view models\n  updateDimensionViewModels(d.parcatsViewModel);\n  updatePathViewModels(d.parcatsViewModel);\n\n  // Update svg geometry\n  updateSvgCategories(d.parcatsViewModel);\n  updateSvgPaths(d.parcatsViewModel);\n}\n\n/**\n * Handle dimension drag end\n * @param {DimensionViewModel} d\n */\nfunction dragDimensionEnd(d) {\n  // Check if dragging is supported\n  if (d.parcatsViewModel.arrangement === 'fixed') {\n    return;\n  }\n  if (d.dragDimensionDisplayInd === null) {\n    return;\n  }\n  d3.select(this).selectAll('text').attr('font-weight', 'normal');\n\n  // Compute restyle command\n  // -----------------------\n  var restyleData = {};\n  var traceInd = getTraceIndex(d.parcatsViewModel);\n\n  // ### Handle dimension reordering ###\n  var finalDragDimensionDisplayInds = d.parcatsViewModel.model.dimensions.map(function (d) {\n    return d.displayInd;\n  });\n  var anyDimsReordered = d.initialDragDimensionDisplayInds.some(function (initDimDisplay, dimInd) {\n    return initDimDisplay !== finalDragDimensionDisplayInds[dimInd];\n  });\n  if (anyDimsReordered) {\n    finalDragDimensionDisplayInds.forEach(function (finalDimDisplay, dimInd) {\n      var containerInd = d.parcatsViewModel.model.dimensions[dimInd].containerInd;\n      restyleData['dimensions[' + containerInd + '].displayindex'] = finalDimDisplay;\n    });\n  }\n\n  // ### Handle category reordering ###\n  var anyCatsReordered = false;\n  if (d.dragCategoryDisplayInd !== null) {\n    var finalDragCategoryDisplayInds = d.model.categories.map(function (c) {\n      return c.displayInd;\n    });\n    anyCatsReordered = d.initialDragCategoryDisplayInds.some(function (initCatDisplay, catInd) {\n      return initCatDisplay !== finalDragCategoryDisplayInds[catInd];\n    });\n    if (anyCatsReordered) {\n      // Sort a shallow copy of the category models by display index\n      var sortedCategoryModels = d.model.categories.slice().sort(function (a, b) {\n        return a.displayInd - b.displayInd;\n      });\n\n      // Get new categoryarray and ticktext values\n      var newCategoryArray = sortedCategoryModels.map(function (v) {\n        return v.categoryValue;\n      });\n      var newCategoryLabels = sortedCategoryModels.map(function (v) {\n        return v.categoryLabel;\n      });\n      restyleData['dimensions[' + d.model.containerInd + '].categoryarray'] = [newCategoryArray];\n      restyleData['dimensions[' + d.model.containerInd + '].ticktext'] = [newCategoryLabels];\n      restyleData['dimensions[' + d.model.containerInd + '].categoryorder'] = 'array';\n    }\n  }\n\n  // Handle potential click event\n  // ----------------------------\n  if (d.parcatsViewModel.hoverinfoItems.indexOf('skip') === -1) {\n    if (!d.dragHasMoved && d.potentialClickBand) {\n      if (d.parcatsViewModel.hoveron === 'color') {\n        emitPointsEventColorHovermode(d.potentialClickBand, 'plotly_click', d3.event.sourceEvent);\n      } else {\n        emitPointsEventCategoryHovermode(d.potentialClickBand, 'plotly_click', d3.event.sourceEvent);\n      }\n    }\n  }\n\n  // Nullify drag states\n  // -------------------\n  d.model.dragX = null;\n  if (d.dragCategoryDisplayInd !== null) {\n    var dragCategory = d.parcatsViewModel.dimensions[d.dragDimensionDisplayInd].categories[d.dragCategoryDisplayInd];\n    dragCategory.model.dragY = null;\n    d.dragCategoryDisplayInd = null;\n  }\n  d.dragDimensionDisplayInd = null;\n  d.parcatsViewModel.dragDimension = null;\n  d.dragHasMoved = null;\n  d.potentialClickBand = null;\n\n  // Update view models\n  // ------------------\n  updateDimensionViewModels(d.parcatsViewModel);\n  updatePathViewModels(d.parcatsViewModel);\n\n  // Perform transition\n  // ------------------\n  var transition = d3.transition().duration(300).ease('cubic-in-out');\n  transition.each(function () {\n    updateSvgCategories(d.parcatsViewModel, true);\n    updateSvgPaths(d.parcatsViewModel, true);\n  }).each('end', function () {\n    if (anyDimsReordered || anyCatsReordered) {\n      // Perform restyle if the order of categories or dimensions changed\n      Plotly.restyle(d.parcatsViewModel.graphDiv, restyleData, [traceInd]);\n    }\n  });\n}\n\n/**\n *\n * @param {ParcatsViewModel} parcatsViewModel\n */\nfunction getTraceIndex(parcatsViewModel) {\n  var traceInd;\n  var allTraces = parcatsViewModel.graphDiv._fullData;\n  for (var i = 0; i < allTraces.length; i++) {\n    if (parcatsViewModel.key === allTraces[i].uid) {\n      traceInd = i;\n      break;\n    }\n  }\n  return traceInd;\n}\n\n/** Update the svg paths for view model\n * @param {ParcatsViewModel} parcatsViewModel\n * @param {boolean} hasTransition Whether to update element with transition\n */\nfunction updateSvgPaths(parcatsViewModel, hasTransition) {\n  if (hasTransition === undefined) {\n    hasTransition = false;\n  }\n  function transition(selection) {\n    return hasTransition ? selection.transition() : selection;\n  }\n\n  // Update binding\n  parcatsViewModel.pathSelection.data(function (d) {\n    return d.paths;\n  }, key);\n\n  // Update paths\n  transition(parcatsViewModel.pathSelection).attr('d', function (d) {\n    return d.svgD;\n  });\n}\n\n/** Update the svg paths for view model\n * @param {ParcatsViewModel} parcatsViewModel\n * @param {boolean} hasTransition Whether to update element with transition\n */\nfunction updateSvgCategories(parcatsViewModel, hasTransition) {\n  if (hasTransition === undefined) {\n    hasTransition = false;\n  }\n  function transition(selection) {\n    return hasTransition ? selection.transition() : selection;\n  }\n\n  // Update binding\n  parcatsViewModel.dimensionSelection.data(function (d) {\n    return d.dimensions;\n  }, key);\n  var categorySelection = parcatsViewModel.dimensionSelection.selectAll('g.category').data(function (d) {\n    return d.categories;\n  }, key);\n\n  // Update dimension position\n  transition(parcatsViewModel.dimensionSelection).attr('transform', function (d) {\n    return 'translate(' + d.x + ', 0)';\n  });\n\n  // Update category position\n  transition(categorySelection).attr('transform', function (d) {\n    return 'translate(0, ' + d.y + ')';\n  });\n  var dimLabelSelection = categorySelection.select('.dimlabel');\n\n  // ### Update dimension label\n  // Only the top-most display category should have the dimension label\n  dimLabelSelection.text(function (d, i) {\n    if (i === 0) {\n      // Add dimension label above topmost category\n      return d.parcatsViewModel.model.dimensions[d.model.dimensionInd].dimensionLabel;\n    } else {\n      return null;\n    }\n  });\n\n  // Update category label\n  // Categories in the right-most display dimension have their labels on\n  // the right, all others on the left\n  var catLabelSelection = categorySelection.select('.catlabel');\n  catLabelSelection.attr('text-anchor', function (d) {\n    if (catInRightDim(d)) {\n      // Place label to the right of category\n      return 'start';\n    } else {\n      // Place label to the left of category\n      return 'end';\n    }\n  }).attr('x', function (d) {\n    if (catInRightDim(d)) {\n      // Place label to the right of category\n      return d.width + 5;\n    } else {\n      // Place label to the left of category\n      return -5;\n    }\n  }).each(function (d) {\n    // Update attriubutes of <tspan> elements\n    var newX;\n    var newAnchor;\n    if (catInRightDim(d)) {\n      // Place label to the right of category\n      newX = d.width + 5;\n      newAnchor = 'start';\n    } else {\n      // Place label to the left of category\n      newX = -5;\n      newAnchor = 'end';\n    }\n    d3.select(this).selectAll('tspan').attr('x', newX).attr('text-anchor', newAnchor);\n  });\n\n  // Update bands\n  // Initialize color band rects\n  var bandSelection = categorySelection.selectAll('rect.bandrect').data( /** @param {CategoryViewModel} catViewModel*/\n  function (catViewModel) {\n    return catViewModel.bands;\n  }, key);\n  var bandsSelectionEnter = bandSelection.enter().append('rect').attr('class', 'bandrect').attr('cursor', 'move').attr('stroke-opacity', 0).attr('fill', function (d) {\n    return d.color;\n  }).attr('fill-opacity', 0);\n  bandSelection.attr('fill', function (d) {\n    return d.color;\n  }).attr('width', function (d) {\n    return d.width;\n  }).attr('height', function (d) {\n    return d.height;\n  }).attr('y', function (d) {\n    return d.y;\n  });\n  styleBandsNoHover(bandsSelectionEnter);\n\n  // Raise bands to the top\n  bandSelection.each(function () {\n    Lib.raiseToTop(this);\n  });\n\n  // Remove unused bands\n  bandSelection.exit().remove();\n}\n\n/**\n * Create a ParcatsViewModel traces\n * @param {Object} graphDiv\n *  Top-level graph div element\n * @param {Layout} layout\n *  SVG layout object\n * @param {Array.<ParcatsModel>} wrappedParcatsModel\n *  Wrapped ParcatsModel for this trace\n * @return {ParcatsViewModel}\n */\nfunction createParcatsViewModel(graphDiv, layout, wrappedParcatsModel) {\n  // Unwrap model\n  var parcatsModel = wrappedParcatsModel[0];\n\n  // Compute margin\n  var margin = layout.margin || {\n    l: 80,\n    r: 80,\n    t: 100,\n    b: 80\n  };\n\n  // Compute pixel position/extents\n  var trace = parcatsModel.trace;\n  var domain = trace.domain;\n  var figureWidth = layout.width;\n  var figureHeight = layout.height;\n  var traceWidth = Math.floor(figureWidth * (domain.x[1] - domain.x[0]));\n  var traceHeight = Math.floor(figureHeight * (domain.y[1] - domain.y[0]));\n  var traceX = domain.x[0] * figureWidth + margin.l;\n  var traceY = layout.height - domain.y[1] * layout.height + margin.t;\n\n  // Handle path shape\n  // -----------------\n  var pathShape = trace.line.shape;\n\n  // Handle hover info\n  // -----------------\n  var hoverinfoItems;\n  if (trace.hoverinfo === 'all') {\n    hoverinfoItems = ['count', 'probability'];\n  } else {\n    hoverinfoItems = trace.hoverinfo.split('+');\n  }\n\n  // Construct parcatsViewModel\n  // --------------------------\n  var parcatsViewModel = {\n    key: trace.uid,\n    model: parcatsModel,\n    x: traceX,\n    y: traceY,\n    width: traceWidth,\n    height: traceHeight,\n    hoveron: trace.hoveron,\n    hoverinfoItems: hoverinfoItems,\n    arrangement: trace.arrangement,\n    bundlecolors: trace.bundlecolors,\n    sortpaths: trace.sortpaths,\n    labelfont: trace.labelfont,\n    categorylabelfont: trace.tickfont,\n    pathShape: pathShape,\n    dragDimension: null,\n    margin: margin,\n    paths: [],\n    dimensions: [],\n    graphDiv: graphDiv,\n    traceSelection: null,\n    pathSelection: null,\n    dimensionSelection: null\n  };\n\n  // Update dimension view models if we have at least 1 dimension\n  if (parcatsModel.dimensions) {\n    updateDimensionViewModels(parcatsViewModel);\n\n    // Update path view models if we have at least 2 dimensions\n    updatePathViewModels(parcatsViewModel);\n  }\n  // Inside a categories view model\n  return parcatsViewModel;\n}\n\n/**\n * Build the SVG string to represents a parallel categories path\n * @param {Array.<Number>} leftXPositions\n *  Array of the x positions of the left edge of each dimension (in display order)\n * @param {Array.<Number>} pathYs\n *  Array of the y positions of the top of the path at each dimension (in display order)\n * @param {Array.<Number>} dimWidths\n *  Array of the widths of each dimension in display order\n * @param {Number} pathHeight\n *  The height of the path in pixels\n * @param {Number} curvature\n *  The curvature factor for the path. 0 results in a straight line and values greater than zero result in curved paths\n * @return {string}\n */\nfunction buildSvgPath(leftXPositions, pathYs, dimWidths, pathHeight, curvature) {\n  // Compute the x midpoint of each path segment\n  var xRefPoints1 = [];\n  var xRefPoints2 = [];\n  var refInterpolator;\n  var d;\n  for (d = 0; d < dimWidths.length - 1; d++) {\n    refInterpolator = d3.interpolateNumber(dimWidths[d] + leftXPositions[d], leftXPositions[d + 1]);\n    xRefPoints1.push(refInterpolator(curvature));\n    xRefPoints2.push(refInterpolator(1 - curvature));\n  }\n\n  // Move to top of path on left edge of left-most category\n  var svgD = 'M ' + leftXPositions[0] + ',' + pathYs[0];\n\n  // Horizontal line to right edge\n  svgD += 'l' + dimWidths[0] + ',0 ';\n\n  // Horizontal line to right edge\n  for (d = 1; d < dimWidths.length; d++) {\n    // Curve to left edge of category\n    svgD += 'C' + xRefPoints1[d - 1] + ',' + pathYs[d - 1] + ' ' + xRefPoints2[d - 1] + ',' + pathYs[d] + ' ' + leftXPositions[d] + ',' + pathYs[d];\n\n    // svgD += 'L' + leftXPositions[d] + ',' + pathYs[d];\n\n    // Horizontal line to right edge\n    svgD += 'l' + dimWidths[d] + ',0 ';\n  }\n\n  // Line down\n  svgD += 'l' + '0,' + pathHeight + ' ';\n\n  // Line to left edge of right-most category\n  svgD += 'l -' + dimWidths[dimWidths.length - 1] + ',0 ';\n  for (d = dimWidths.length - 2; d >= 0; d--) {\n    // Curve to right edge of category\n    svgD += 'C' + xRefPoints2[d] + ',' + (pathYs[d + 1] + pathHeight) + ' ' + xRefPoints1[d] + ',' + (pathYs[d] + pathHeight) + ' ' + (leftXPositions[d] + dimWidths[d]) + ',' + (pathYs[d] + pathHeight);\n\n    // svgD += 'L' + (leftXPositions[d] + dimWidths[d]) + ',' + (pathYs[d] + pathHeight);\n\n    // Horizontal line to right edge\n    svgD += 'l-' + dimWidths[d] + ',0 ';\n  }\n\n  // Close path\n  svgD += 'Z';\n  return svgD;\n}\n\n/**\n * Update the path view models based on the dimension view models in a ParcatsViewModel\n *\n * @param {ParcatsViewModel} parcatsViewModel\n *  View model for trace\n */\nfunction updatePathViewModels(parcatsViewModel) {\n  // Initialize an array of the y position of the top of the next path to be added to each category.\n  //\n  // nextYPositions[d][c] is the y position of the next path through category with index c of dimension with index d\n  var dimensionViewModels = parcatsViewModel.dimensions;\n  var parcatsModel = parcatsViewModel.model;\n  var nextYPositions = dimensionViewModels.map(function (d) {\n    return d.categories.map(function (c) {\n      return c.y;\n    });\n  });\n\n  // Array from category index to category display index for each true dimension index\n  var catToDisplayIndPerDim = parcatsViewModel.model.dimensions.map(function (d) {\n    return d.categories.map(function (c) {\n      return c.displayInd;\n    });\n  });\n\n  // Array from true dimension index to dimension display index\n  var dimToDisplayInd = parcatsViewModel.model.dimensions.map(function (d) {\n    return d.displayInd;\n  });\n  var displayToDimInd = parcatsViewModel.dimensions.map(function (d) {\n    return d.model.dimensionInd;\n  });\n\n  // Array of the x position of the left edge of the rectangles for each dimension\n  var leftXPositions = dimensionViewModels.map(function (d) {\n    return d.x;\n  });\n\n  // Compute dimension widths\n  var dimWidths = dimensionViewModels.map(function (d) {\n    return d.width;\n  });\n\n  // Build sorted Array of PathModel objects\n  var pathModels = [];\n  for (var p in parcatsModel.paths) {\n    if (parcatsModel.paths.hasOwnProperty(p)) {\n      pathModels.push(parcatsModel.paths[p]);\n    }\n  }\n\n  // Compute category display inds to use for sorting paths\n  function pathDisplayCategoryInds(pathModel) {\n    var dimensionInds = pathModel.categoryInds.map(function (catInd, dimInd) {\n      return catToDisplayIndPerDim[dimInd][catInd];\n    });\n    var displayInds = displayToDimInd.map(function (dimInd) {\n      return dimensionInds[dimInd];\n    });\n    return displayInds;\n  }\n\n  // Sort in ascending order by display index array\n  pathModels.sort(function (v1, v2) {\n    // Build display inds for each path\n    var sortArray1 = pathDisplayCategoryInds(v1);\n    var sortArray2 = pathDisplayCategoryInds(v2);\n\n    // Handle path sort order\n    if (parcatsViewModel.sortpaths === 'backward') {\n      sortArray1.reverse();\n      sortArray2.reverse();\n    }\n\n    // Append the first value index of the path to break ties\n    sortArray1.push(v1.valueInds[0]);\n    sortArray2.push(v2.valueInds[0]);\n\n    // Handle color bundling\n    if (parcatsViewModel.bundlecolors) {\n      // Prepend sort array with the raw color value\n      sortArray1.unshift(v1.rawColor);\n      sortArray2.unshift(v2.rawColor);\n    }\n\n    // colors equal, sort by display categories\n    if (sortArray1 < sortArray2) {\n      return -1;\n    }\n    if (sortArray1 > sortArray2) {\n      return 1;\n    }\n    return 0;\n  });\n\n  // Create path models\n  var pathViewModels = new Array(pathModels.length);\n  var totalCount = dimensionViewModels[0].model.count;\n  var totalHeight = dimensionViewModels[0].categories.map(function (c) {\n    return c.height;\n  }).reduce(function (v1, v2) {\n    return v1 + v2;\n  });\n  for (var pathNumber = 0; pathNumber < pathModels.length; pathNumber++) {\n    var pathModel = pathModels[pathNumber];\n    var pathHeight;\n    if (totalCount > 0) {\n      pathHeight = totalHeight * (pathModel.count / totalCount);\n    } else {\n      pathHeight = 0;\n    }\n\n    // Build path y coords\n    var pathYs = new Array(nextYPositions.length);\n    for (var d = 0; d < pathModel.categoryInds.length; d++) {\n      var catInd = pathModel.categoryInds[d];\n      var catDisplayInd = catToDisplayIndPerDim[d][catInd];\n      var dimDisplayInd = dimToDisplayInd[d];\n\n      // Update next y position\n      pathYs[dimDisplayInd] = nextYPositions[dimDisplayInd][catDisplayInd];\n      nextYPositions[dimDisplayInd][catDisplayInd] += pathHeight;\n\n      // Update category color information\n      var catViewModle = parcatsViewModel.dimensions[dimDisplayInd].categories[catDisplayInd];\n      var numBands = catViewModle.bands.length;\n      var lastCatBand = catViewModle.bands[numBands - 1];\n      if (lastCatBand === undefined || pathModel.rawColor !== lastCatBand.rawColor) {\n        // Create a new band\n        var bandY = lastCatBand === undefined ? 0 : lastCatBand.y + lastCatBand.height;\n        catViewModle.bands.push({\n          key: bandY,\n          color: pathModel.color,\n          rawColor: pathModel.rawColor,\n          height: pathHeight,\n          width: catViewModle.width,\n          count: pathModel.count,\n          y: bandY,\n          categoryViewModel: catViewModle,\n          parcatsViewModel: parcatsViewModel\n        });\n      } else {\n        // Extend current band\n        var currentBand = catViewModle.bands[numBands - 1];\n        currentBand.height += pathHeight;\n        currentBand.count += pathModel.count;\n      }\n    }\n\n    // build svg path\n    var svgD;\n    if (parcatsViewModel.pathShape === 'hspline') {\n      svgD = buildSvgPath(leftXPositions, pathYs, dimWidths, pathHeight, 0.5);\n    } else {\n      svgD = buildSvgPath(leftXPositions, pathYs, dimWidths, pathHeight, 0);\n    }\n    pathViewModels[pathNumber] = {\n      key: pathModel.valueInds[0],\n      model: pathModel,\n      height: pathHeight,\n      leftXs: leftXPositions,\n      topYs: pathYs,\n      dimWidths: dimWidths,\n      svgD: svgD,\n      parcatsViewModel: parcatsViewModel\n    };\n  }\n  parcatsViewModel.paths = pathViewModels;\n\n  // * @property key\n  // *  Unique key for this model\n  // * @property {PathModel} model\n  // *  Source path model\n  // * @property {Number} height\n  // *  Height of this path (pixels)\n  // * @property {String} svgD\n  // *  SVG path \"d\" attribute string\n}\n\n/**\n * Update the dimension view models based on the dimension models in a ParcatsViewModel\n *\n * @param {ParcatsViewModel} parcatsViewModel\n *  View model for trace\n */\nfunction updateDimensionViewModels(parcatsViewModel) {\n  // Compute dimension ordering\n  var dimensionsIndInfo = parcatsViewModel.model.dimensions.map(function (d) {\n    return {\n      displayInd: d.displayInd,\n      dimensionInd: d.dimensionInd\n    };\n  });\n  dimensionsIndInfo.sort(function (a, b) {\n    return a.displayInd - b.displayInd;\n  });\n  var dimensions = [];\n  for (var displayInd in dimensionsIndInfo) {\n    var dimensionInd = dimensionsIndInfo[displayInd].dimensionInd;\n    var dimModel = parcatsViewModel.model.dimensions[dimensionInd];\n    dimensions.push(createDimensionViewModel(parcatsViewModel, dimModel));\n  }\n  parcatsViewModel.dimensions = dimensions;\n}\n\n/**\n * Create a parcats DimensionViewModel\n *\n * @param {ParcatsViewModel} parcatsViewModel\n *  View model for trace\n * @param {DimensionModel} dimensionModel\n * @return {DimensionViewModel}\n */\nfunction createDimensionViewModel(parcatsViewModel, dimensionModel) {\n  // Compute dimension x position\n  var categoryLabelPad = 40;\n  var dimWidth = 16;\n  var numDimensions = parcatsViewModel.model.dimensions.length;\n  var displayInd = dimensionModel.displayInd;\n\n  // Compute x coordinate values\n  var dimDx;\n  var dimX0;\n  var dimX;\n  if (numDimensions > 1) {\n    dimDx = (parcatsViewModel.width - 2 * categoryLabelPad - dimWidth) / (numDimensions - 1);\n  } else {\n    dimDx = 0;\n  }\n  dimX0 = categoryLabelPad;\n  dimX = dimX0 + dimDx * displayInd;\n\n  // Compute categories\n  var categories = [];\n  var maxCats = parcatsViewModel.model.maxCats;\n  var numCats = dimensionModel.categories.length;\n  var catSpacing = 8;\n  var totalCount = dimensionModel.count;\n  var totalHeight = parcatsViewModel.height - catSpacing * (maxCats - 1);\n  var nextCatHeight;\n  var nextCatModel;\n  var nextCat;\n  var catInd;\n  var catDisplayInd;\n\n  // Compute starting Y offset\n  var nextCatY = (maxCats - numCats) * catSpacing / 2.0;\n\n  // Compute category ordering\n  var categoryIndInfo = dimensionModel.categories.map(function (c) {\n    return {\n      displayInd: c.displayInd,\n      categoryInd: c.categoryInd\n    };\n  });\n  categoryIndInfo.sort(function (a, b) {\n    return a.displayInd - b.displayInd;\n  });\n  for (catDisplayInd = 0; catDisplayInd < numCats; catDisplayInd++) {\n    catInd = categoryIndInfo[catDisplayInd].categoryInd;\n    nextCatModel = dimensionModel.categories[catInd];\n    if (totalCount > 0) {\n      nextCatHeight = nextCatModel.count / totalCount * totalHeight;\n    } else {\n      nextCatHeight = 0;\n    }\n    nextCat = {\n      key: nextCatModel.valueInds[0],\n      model: nextCatModel,\n      width: dimWidth,\n      height: nextCatHeight,\n      y: nextCatModel.dragY !== null ? nextCatModel.dragY : nextCatY,\n      bands: [],\n      parcatsViewModel: parcatsViewModel\n    };\n    nextCatY = nextCatY + nextCatHeight + catSpacing;\n    categories.push(nextCat);\n  }\n  return {\n    key: dimensionModel.dimensionInd,\n    x: dimensionModel.dragX !== null ? dimensionModel.dragX : dimX,\n    y: 0,\n    width: dimWidth,\n    model: dimensionModel,\n    categories: categories,\n    parcatsViewModel: parcatsViewModel,\n    dragCategoryDisplayInd: null,\n    dragDimensionDisplayInd: null,\n    initialDragDimensionDisplayInds: null,\n    initialDragCategoryDisplayInds: null,\n    dragHasMoved: null,\n    potentialClickBand: null\n  };\n}\n\n// JSDoc typedefs\n// ==============\n/**\n * @typedef {Object} Layout\n *  Object containing svg layout information\n *\n * @property {Number} width (pixels)\n *  Usable width for Figure (after margins are removed)\n * @property {Number} height (pixels)\n *  Usable height for Figure (after margins are removed)\n * @property {Margin} margin\n *  Margin around the Figure (pixels)\n */\n\n/**\n * @typedef {Object} Margin\n *  Object containing padding information in pixels\n *\n * @property {Number} t\n *  Top margin\n * @property {Number} r\n *  Right margin\n * @property {Number} b\n *  Bottom margin\n * @property {Number} l\n *  Left margin\n */\n\n/**\n * @typedef {Object} Font\n *  Object containing font information\n *\n * @property {Number} size: Font size\n * @property {String} color: Font color\n * @property {String} family: Font family\n */\n\n/**\n * @typedef {Object} ParcatsViewModel\n *  Object containing calculated parcats view information\n *\n *  These are quantities that require Layout information to calculate\n * @property key\n *  Unique key for this model\n * @property {ParcatsModel} model\n *  Source parcats model\n * @property {Array.<DimensionViewModel>} dimensions\n *  Array of dimension view models\n * @property {Number} width\n *  Width for this trace (pixels)\n * @property {Number} height\n *  Height for this trace (pixels)\n * @property {Number} x\n *  X position of this trace with respect to the Figure (pixels)\n * @property {Number} y\n *  Y position of this trace with respect to the Figure (pixels)\n * @property {String} hoveron\n *  Hover interaction mode. One of: 'category', 'color', or 'dimension'\n * @property {Array.<String>} hoverinfoItems\n *  Info to display on hover. Array with a combination of 'counts' and/or 'probabilities', or 'none', or 'skip'\n * @property {String} arrangement\n *  Category arrangement. One of: 'perpendicular', 'freeform', or 'fixed'\n * @property {Boolean} bundlecolors\n *  Whether paths should be sorted so that like colors are bundled together as they pass through categories\n * @property {String} sortpaths\n *  If 'forward' then sort paths based on dimensions from left to right. If 'backward' sort based on dimensions\n *  from right to left\n * @property {Font} labelfont\n *  Font for the dimension labels\n * @property {Font} categorylabelfont\n *  Font for the category labels\n * @property {String} pathShape\n *  The shape of the paths. Either 'linear' or 'hspline'.\n * @property {DimensionViewModel|null} dragDimension\n *  Dimension currently being dragged. Null if no drag in progress\n * @property {Margin} margin\n *  Margin around the Figure\n * @property {Object} graphDiv\n *  Top-level graph div element\n * @property {Object} traceSelection\n *  D3 selection of this view models trace group element\n * @property {Object} pathSelection\n *  D3 selection of this view models path elements\n * @property {Object} dimensionSelection\n *  D3 selection of this view models dimension group element\n */\n\n/**\n * @typedef {Object} DimensionViewModel\n *  Object containing calculated parcats dimension view information\n *\n *  These are quantities that require Layout information to calculate\n * @property key\n *  Unique key for this model\n * @property {DimensionModel} model\n *  Source dimension model\n * @property {Number} x\n *  X position of the center of this dimension with respect to the Figure (pixels)\n * @property {Number} y\n *  Y position of the top of this dimension with respect to the Figure (pixels)\n * @property {Number} width\n *  Width of categories in this dimension (pixels)\n * @property {ParcatsViewModel} parcatsViewModel\n *  The parent trace's view model\n * @property {Array.<CategoryViewModel>} categories\n *  Dimensions category view models\n * @property {Number|null} dragCategoryDisplayInd\n *  Display index of category currently being dragged. null if no category is being dragged\n * @property {Number|null} dragDimensionDisplayInd\n *  Display index of the dimension being dragged. null if no dimension is being dragged\n * @property {Array.<Number>|null} initialDragDimensionDisplayInds\n *  Dimensions display indexes at the beginning of the current drag. null if no dimension is being dragged\n * @property {Array.<Number>|null} initialDragCategoryDisplayInds\n *  Category display indexes for the at the beginning of the current drag. null if no category is being dragged\n * @property {HTMLElement} potentialClickBand\n *  Band under mouse when current drag began. If no drag movement takes place then a click will be emitted for this\n *  band. Null if not drag in progress.\n * @property {Boolean} dragHasMoved\n *  True if there is an active drag and the drag has moved. If drag doesn't move before being ended then\n *  this may be interpreted as a click. Null if no drag in progress\n */\n\n/**\n * @typedef {Object} CategoryViewModel\n *  Object containing calculated parcats category view information\n *\n *  These are quantities that require Layout information to calculate\n * @property key\n *  Unique key for this model\n * @property {CategoryModel} model\n *  Source category model\n * @property {Number} width\n *  Width for this category (pixels)\n * @property {Number} height\n *  Height for this category (pixels)\n * @property {Number} y\n *  Y position of this cateogry with respect to the Figure (pixels)\n * @property {Array.<CategoryBandViewModel>} bands\n *  Array of color bands inside the category\n * @property {ParcatsViewModel} parcatsViewModel\n *  The parent trace's view model\n */\n\n/**\n * @typedef {Object} CategoryBandViewModel\n *  Object containing calculated category band information. A category band is a region inside a category covering\n *  paths of a single color\n *\n * @property key\n *  Unique key for this model\n * @property color\n *  Band color\n * @property rawColor\n *  Raw color value for band\n * @property {Number} width\n *  Band width\n * @property {Number} height\n *  Band height\n * @property {Number} y\n *  Y position of top of the band with respect to the category\n * @property {Number} count\n *  The number of samples represented by the band\n * @property {CategoryViewModel} categoryViewModel\n *  The parent categorie's view model\n * @property {ParcatsViewModel} parcatsViewModel\n *  The parent trace's view model\n */\n\n/**\n * @typedef {Object} PathViewModel\n *  Object containing calculated parcats path view information\n *\n *  These are quantities that require Layout information to calculate\n * @property key\n *  Unique key for this model\n * @property {PathModel} model\n *  Source path model\n * @property {Number} height\n *  Height of this path (pixels)\n * @property {Array.<Number>} leftXs\n *  The x position of the left edge of each display dimension\n * @property {Array.<Number>} topYs\n *  The y position of the top of the path for each display dimension\n * @property {Array.<Number>} dimWidths\n *  The width of each display dimension\n * @property {String} svgD\n *  SVG path \"d\" attribute string\n * @property {ParcatsViewModel} parcatsViewModel\n *  The parent trace's view model\n */","map":{"version":3,"names":["d3","require","Plotly","Fx","Lib","Drawing","tinycolor","svgTextUtils","performPlot","parcatsModels","graphDiv","layout","svg","viewModels","map","createParcatsViewModel","bind","layerSelection","selectAll","data","enter","append","attr","style","traceSelection","key","traceEnter","d","x","y","pathsSelection","select","pathSelection","paths","model","color","pathSelectionEnter","stylePathsNoHover","svgD","empty","sort","compareRawColor","exit","remove","on","mouseoverPath","mouseoutPath","clickPath","dimensionsSelection","dimensionSelection","dimensions","categorySelection","categories","categoryGroupEnterSelection","width","height","styleCategoriesNoHover","bandSelection","catViewModel","bands","each","raiseToTop","bandsSelectionEnter","bandModel","parcatsViewModel","arrangement","styleBandsNoHover","paperColor","_fullLayout","paper_bgcolor","catInRightDim","text","categoryLabel","catModel","font","categorylabelfont","convertToTspans","i","dimensionInd","dimensionLabel","labelfont","mouseoverCategoryBand","mouseoutCategory","call","behavior","drag","origin","dragDimensionStart","dragDimension","dragDimensionEnd","module","exports","numDims","length","leftDimInd","a","b","rawColor","hoverinfoItems","indexOf","stylePathsHover","points","buildPointsArrayForPath","emit","event","hoverX","mouse","gd","fullLayout","rootBBox","_paperdiv","node","getBoundingClientRect","graphDivBBox","pathCenterX","pathCenterY","dimInd","leftXs","dimWidths","leftDim","rightDim","topYs","hoverCenterX","hoverCenterY","textColor","mostReadable","hovertextParts","push","count","join","toFixed","hovertext","mouseX","loneHover","left","top","borderColor","fontFamily","fontSize","fontColor","idealAlign","container","_hoverlayer","outerContainer","_paper","loneUnhover","curveNumber","getTraceIndex","valueInds","pointNumber","styleCategoryHover","styleBandsHover","bandsSelection","selectPathsThroughCategoryBandColor","catBandViewModel","allPaths","categoryViewModel","catInd","categoryInd","filter","pathViewModel","categoryInds","styleForCategoryHovermode","bandElement","bandSel","parentNode","bvm","styleForColorHovermode","bandViewModel","datum","catPaths","emitPointsEventCategoryHovermode","eventName","Array","prototype","apply","emitPointsEventColorHovermode","createHoverLabelForCategoryHovermode","rectSelection","rectBoundingBox","dimensionModel","hoverLabelIdealAlign","displayInd","hoverinfoParts","createHoverLabelForDimensionHovermode","allHoverlabels","bandNode","createHoverLabelForColorHovermode","bandBoundingBox","catLabel","totalCount","bandColorCount","forEach","catCount","colorCount","pColorAndCatLable","pColorAndCatValue","pColorAndCatRow","pCatGivenColorLabel","pCatGivenColorValue","pCatGivenColorRow","pColorGivenCatLabel","pColorGivenCatValue","pColorGivenCatRow","mouseY","hoveron","hoverItems","multiHovers","dragDimensionDisplayInd","initialDragDimensionDisplayInds","dragHasMoved","dragCategoryDisplayInd","catMouseX","catMouseY","initialDragCategoryDisplayInds","c","dragY","potentialClickBand","dragDimInd","prevDimInd","nextDimInd","dragCategory","dy","categoryY","catDisplayInd","dimCategoryViews","catAbove","catBelow","undefined","dragX","prevDimension","nextDimension","updateDimensionViewModels","updatePathViewModels","updateSvgCategories","updateSvgPaths","restyleData","traceInd","finalDragDimensionDisplayInds","anyDimsReordered","some","initDimDisplay","finalDimDisplay","containerInd","anyCatsReordered","finalDragCategoryDisplayInds","initCatDisplay","sortedCategoryModels","slice","newCategoryArray","v","categoryValue","newCategoryLabels","sourceEvent","transition","duration","ease","restyle","allTraces","_fullData","uid","hasTransition","selection","dimLabelSelection","catLabelSelection","newX","newAnchor","wrappedParcatsModel","parcatsModel","margin","l","r","t","trace","domain","figureWidth","figureHeight","traceWidth","Math","floor","traceHeight","traceX","traceY","pathShape","line","shape","hoverinfo","split","bundlecolors","sortpaths","tickfont","buildSvgPath","leftXPositions","pathYs","pathHeight","curvature","xRefPoints1","xRefPoints2","refInterpolator","interpolateNumber","dimensionViewModels","nextYPositions","catToDisplayIndPerDim","dimToDisplayInd","displayToDimInd","pathModels","p","hasOwnProperty","pathDisplayCategoryInds","pathModel","dimensionInds","displayInds","v1","v2","sortArray1","sortArray2","reverse","unshift","pathViewModels","totalHeight","reduce","pathNumber","dimDisplayInd","catViewModle","numBands","lastCatBand","bandY","currentBand","dimensionsIndInfo","dimModel","createDimensionViewModel","categoryLabelPad","dimWidth","numDimensions","dimDx","dimX0","dimX","maxCats","numCats","catSpacing","nextCatHeight","nextCatModel","nextCat","nextCatY","categoryIndInfo"],"sources":["/home/yasmin/Área de Trabalho/Frontend/node_modules/plotly.js/src/traces/parcats/parcats.js"],"sourcesContent":["/**\n* Copyright 2012-2019, Plotly, Inc.\n* All rights reserved.\n*\n* This source code is licensed under the MIT license found in the\n* LICENSE file in the root directory of this source tree.\n*/\n\n'use strict';\n\nvar d3 = require('d3');\nvar Plotly = require('../../plot_api/plot_api');\nvar Fx = require('../../components/fx');\nvar Lib = require('../../lib');\nvar Drawing = require('../../components/drawing');\nvar tinycolor = require('tinycolor2');\nvar svgTextUtils = require('../../lib/svg_text_utils');\n\nfunction performPlot(parcatsModels, graphDiv, layout, svg) {\n\n    var viewModels = parcatsModels.map(createParcatsViewModel.bind(0, graphDiv, layout));\n\n    // Get (potentially empty) parcatslayer selection with bound data to single element array\n    var layerSelection = svg.selectAll('g.parcatslayer').data([null]);\n\n    // Initialize single parcatslayer group if it doesn't exist\n    layerSelection.enter()\n        .append('g')\n        .attr('class', 'parcatslayer')\n        .style('pointer-events', 'all');\n\n    // Bind data to children of layerSelection and get reference to traceSelection\n    var traceSelection = layerSelection\n        .selectAll('g.trace.parcats')\n        .data(viewModels, key);\n\n    // Initialize group for each trace/dimensions\n    var traceEnter = traceSelection.enter()\n        .append('g')\n        .attr('class', 'trace parcats');\n\n    // Update properties for each trace\n    traceSelection\n        .attr('transform', function(d) {\n            return 'translate(' + d.x + ', ' + d.y + ')';\n        });\n\n    // Initialize paths group\n    traceEnter\n        .append('g')\n        .attr('class', 'paths');\n\n    // Update paths transform\n    var pathsSelection = traceSelection\n        .select('g.paths');\n\n    // Get paths selection\n    var pathSelection = pathsSelection\n        .selectAll('path.path')\n        .data(function(d) {\n            return d.paths;\n        }, key);\n\n    // Update existing path colors\n    pathSelection\n        .attr('fill', function(d) {\n            return d.model.color;\n        });\n\n    // Create paths\n    var pathSelectionEnter = pathSelection\n        .enter()\n        .append('path')\n        .attr('class', 'path')\n        .attr('stroke-opacity', 0)\n        .attr('fill', function(d) {\n            return d.model.color;\n        })\n        .attr('fill-opacity', 0);\n\n    stylePathsNoHover(pathSelectionEnter);\n\n    // Set path geometry\n    pathSelection\n        .attr('d', function(d) {\n            return d.svgD;\n        });\n\n    // sort paths\n    if(!pathSelectionEnter.empty()) {\n        // Only sort paths if there has been a change.\n        // Otherwise paths are already sorted or a hover operation may be in progress\n        pathSelection.sort(compareRawColor);\n    }\n\n    // Remove any old paths\n    pathSelection.exit().remove();\n\n    // Path hover\n    pathSelection\n        .on('mouseover', mouseoverPath)\n        .on('mouseout', mouseoutPath)\n        .on('click', clickPath);\n\n    // Initialize dimensions group\n    traceEnter.append('g').attr('class', 'dimensions');\n\n    // Update dimensions transform\n    var dimensionsSelection = traceSelection\n        .select('g.dimensions');\n\n    // Get dimension selection\n    var dimensionSelection = dimensionsSelection\n        .selectAll('g.dimension')\n        .data(function(d) {\n            return d.dimensions;\n        }, key);\n\n    // Create dimension groups\n    dimensionSelection.enter()\n        .append('g')\n        .attr('class', 'dimension');\n\n    // Update dimension group transforms\n    dimensionSelection.attr('transform', function(d) {\n        return 'translate(' + d.x + ', 0)';\n    });\n\n    // Remove any old dimensions\n    dimensionSelection.exit().remove();\n\n    // Get category selection\n    var categorySelection = dimensionSelection\n        .selectAll('g.category')\n        .data(function(d) {\n            return d.categories;\n        }, key);\n\n    // Initialize category groups\n    var categoryGroupEnterSelection = categorySelection\n        .enter()\n        .append('g')\n        .attr('class', 'category');\n\n    // Update category transforms\n    categorySelection\n        .attr('transform', function(d) {\n            return 'translate(0, ' + d.y + ')';\n        });\n\n\n    // Initialize rectangle\n    categoryGroupEnterSelection\n        .append('rect')\n        .attr('class', 'catrect')\n        .attr('pointer-events', 'none');\n\n\n    // Update rectangle\n    categorySelection.select('rect.catrect')\n        .attr('fill', 'none')\n        .attr('width', function(d) {\n            return d.width;\n        })\n        .attr('height', function(d) {\n            return d.height;\n        });\n\n    styleCategoriesNoHover(categoryGroupEnterSelection);\n\n    // Initialize color band rects\n    var bandSelection = categorySelection\n        .selectAll('rect.bandrect')\n        .data(\n            /** @param {CategoryViewModel} catViewModel*/\n            function(catViewModel) {\n                return catViewModel.bands;\n            }, key);\n\n    // Raise all update bands to the top so that fading enter/exit bands will be behind\n    bandSelection.each(function() {Lib.raiseToTop(this);});\n\n    // Update band color\n    bandSelection\n        .attr('fill', function(d) {\n            return d.color;\n        });\n\n    var bandsSelectionEnter = bandSelection.enter()\n        .append('rect')\n        .attr('class', 'bandrect')\n        .attr('stroke-opacity', 0)\n        .attr('fill', function(d) {\n            return d.color;\n        })\n        .attr('fill-opacity', 0);\n\n    bandSelection\n        .attr('fill', function(d) {\n            return d.color;\n        })\n        .attr('width', function(d) {\n            return d.width;\n        })\n        .attr('height', function(d) {\n            return d.height;\n        })\n        .attr('y', function(d) {\n            return d.y;\n        })\n        .attr('cursor',\n            /** @param {CategoryBandViewModel} bandModel*/\n            function(bandModel) {\n                if(bandModel.parcatsViewModel.arrangement === 'fixed') {\n                    return 'default';\n                } else if(bandModel.parcatsViewModel.arrangement === 'perpendicular') {\n                    return 'ns-resize';\n                } else {\n                    return 'move';\n                }\n            });\n\n    styleBandsNoHover(bandsSelectionEnter);\n\n    bandSelection.exit().remove();\n\n    // Initialize category label\n    categoryGroupEnterSelection\n        .append('text')\n        .attr('class', 'catlabel')\n        .attr('pointer-events', 'none');\n\n    var paperColor = graphDiv._fullLayout.paper_bgcolor;\n\n    // Update category label\n    categorySelection.select('text.catlabel')\n        .attr('text-anchor',\n            function(d) {\n                if(catInRightDim(d)) {\n                    // Place label to the right of category\n                    return 'start';\n                } else {\n                    // Place label to the left of category\n                    return 'end';\n                }\n            })\n        .attr('alignment-baseline', 'middle')\n\n        .style('text-shadow',\n            paperColor + ' -1px  1px 2px, ' +\n            paperColor + ' 1px  1px 2px, ' +\n            paperColor + '  1px -1px 2px, ' +\n            paperColor + ' -1px -1px 2px')\n        .style('fill', 'rgb(0, 0, 0)')\n        .attr('x',\n            function(d) {\n                if(catInRightDim(d)) {\n                    // Place label to the right of category\n                    return d.width + 5;\n                } else {\n                    // Place label to the left of category\n                    return -5;\n                }\n            })\n        .attr('y', function(d) {\n            return d.height / 2;\n        })\n        .text(function(d) {\n            return d.model.categoryLabel;\n        })\n        .each(\n            /** @param {CategoryViewModel} catModel*/\n            function(catModel) {\n                Drawing.font(d3.select(this), catModel.parcatsViewModel.categorylabelfont);\n                svgTextUtils.convertToTspans(d3.select(this), graphDiv);\n            });\n\n    // Initialize dimension label\n    categoryGroupEnterSelection\n        .append('text')\n        .attr('class', 'dimlabel');\n\n    // Update dimension label\n    categorySelection.select('text.dimlabel')\n        .attr('text-anchor', 'middle')\n        .attr('alignment-baseline', 'baseline')\n        .attr('cursor',\n             /** @param {CategoryViewModel} catModel*/\n            function(catModel) {\n                if(catModel.parcatsViewModel.arrangement === 'fixed') {\n                    return 'default';\n                } else {\n                    return 'ew-resize';\n                }\n            })\n        .attr('x', function(d) {\n            return d.width / 2;\n        })\n        .attr('y', -5)\n        .text(function(d, i) {\n            if(i === 0) {\n                // Add dimension label above topmost category\n                return d.parcatsViewModel.model.dimensions[d.model.dimensionInd].dimensionLabel;\n            } else {\n                return null;\n            }\n        })\n        .each(\n            /** @param {CategoryViewModel} catModel*/\n            function(catModel) {\n                Drawing.font(d3.select(this), catModel.parcatsViewModel.labelfont);\n            });\n\n    // Category hover\n    // categorySelection.select('rect.catrect')\n    categorySelection.selectAll('rect.bandrect')\n        .on('mouseover', mouseoverCategoryBand)\n        .on('mouseout', mouseoutCategory);\n\n    // Remove unused categories\n    categorySelection.exit().remove();\n\n    // Setup drag\n    dimensionSelection.call(d3.behavior.drag()\n        .origin(function(d) {\n            return {x: d.x, y: 0};\n        })\n        .on('dragstart', dragDimensionStart)\n        .on('drag', dragDimension)\n        .on('dragend', dragDimensionEnd));\n\n\n    // Save off selections to view models\n    traceSelection.each(function(d) {\n        d.traceSelection = d3.select(this);\n        d.pathSelection = d3.select(this).selectAll('g.paths').selectAll('path.path');\n        d.dimensionSelection = d3.select(this).selectAll('g.dimensions').selectAll('g.dimension');\n    });\n\n    // Remove any orphan traces\n    traceSelection.exit().remove();\n}\n\n/**\n * Create / update parcat traces\n *\n * @param {Object} graphDiv\n * @param {Object} svg\n * @param {Array.<ParcatsModel>} parcatsModels\n * @param {Layout} layout\n */\nmodule.exports = function(graphDiv, svg, parcatsModels, layout) {\n    performPlot(parcatsModels, graphDiv, layout, svg);\n};\n\n/**\n * Function the returns the key property of an object for use with as D3 join function\n * @param d\n */\nfunction key(d) {\n    return d.key;\n}\n\n /** True if a category view model is in the right-most display dimension\n  * @param {CategoryViewModel} d */\nfunction catInRightDim(d) {\n    var numDims = d.parcatsViewModel.dimensions.length;\n    var leftDimInd = d.parcatsViewModel.dimensions[numDims - 1].model.dimensionInd;\n    return d.model.dimensionInd === leftDimInd;\n}\n\n/**\n * @param {PathViewModel} a\n * @param {PathViewModel} b\n */\nfunction compareRawColor(a, b) {\n    if(a.model.rawColor > b.model.rawColor) {\n        return 1;\n    } else if(a.model.rawColor < b.model.rawColor) {\n        return -1;\n    } else {\n        return 0;\n    }\n}\n\n/**\n * Handle path mouseover\n * @param {PathViewModel} d\n */\nfunction mouseoverPath(d) {\n\n    if(!d.parcatsViewModel.dragDimension) {\n        // We're not currently dragging\n\n        if(d.parcatsViewModel.hoverinfoItems.indexOf('skip') === -1) {\n            // hoverinfo is not skip, so we at least style the paths and emit interaction events\n\n            // Raise path to top\n            Lib.raiseToTop(this);\n\n            stylePathsHover(d3.select(this));\n\n            // Emit hover event\n            var points = buildPointsArrayForPath(d);\n            d.parcatsViewModel.graphDiv.emit('plotly_hover', {points: points, event: d3.event});\n\n            // Handle hover label\n            if(d.parcatsViewModel.hoverinfoItems.indexOf('none') === -1) {\n                // hoverinfo is a combination of 'count' and 'probability'\n\n                // Mouse\n                var hoverX = d3.mouse(this)[0];\n\n                // Label\n                var gd = d.parcatsViewModel.graphDiv;\n                var fullLayout = gd._fullLayout;\n                var rootBBox = fullLayout._paperdiv.node().getBoundingClientRect();\n                var graphDivBBox = d.parcatsViewModel.graphDiv.getBoundingClientRect();\n\n                // Find path center in path coordinates\n                var pathCenterX,\n                    pathCenterY,\n                    dimInd;\n\n                for(dimInd = 0; dimInd < (d.leftXs.length - 1); dimInd++) {\n                    if(d.leftXs[dimInd] + d.dimWidths[dimInd] - 2 <= hoverX && hoverX <= d.leftXs[dimInd + 1] + 2) {\n                        var leftDim = d.parcatsViewModel.dimensions[dimInd];\n                        var rightDim = d.parcatsViewModel.dimensions[dimInd + 1];\n                        pathCenterX = (leftDim.x + leftDim.width + rightDim.x) / 2;\n                        pathCenterY = (d.topYs[dimInd] + d.topYs[dimInd + 1] + d.height) / 2;\n                        break;\n                    }\n                }\n\n                // Find path center in root coordinates\n                var hoverCenterX = d.parcatsViewModel.x + pathCenterX;\n                var hoverCenterY = d.parcatsViewModel.y + pathCenterY;\n\n                var textColor = tinycolor.mostReadable(d.model.color, ['black', 'white']);\n\n                // Build hover text\n                var hovertextParts = [];\n                if(d.parcatsViewModel.hoverinfoItems.indexOf('count') !== -1) {\n                    hovertextParts.push(['Count:', d.model.count].join(' '));\n                }\n                if(d.parcatsViewModel.hoverinfoItems.indexOf('probability') !== -1) {\n                    hovertextParts.push(['P:', (d.model.count / d.parcatsViewModel.model.count).toFixed(3)].join(' '));\n                }\n\n                var hovertext = hovertextParts.join('<br>');\n                var mouseX = d3.mouse(gd)[0];\n\n                Fx.loneHover({\n                    x: hoverCenterX - rootBBox.left + graphDivBBox.left,\n                    y: hoverCenterY - rootBBox.top + graphDivBBox.top,\n                    text: hovertext,\n                    color: d.model.color,\n                    borderColor: 'black',\n                    fontFamily: 'Monaco, \"Courier New\", monospace',\n                    fontSize: 10,\n                    fontColor: textColor,\n                    idealAlign: mouseX < hoverCenterX ? 'right' : 'left'\n                }, {\n                    container: fullLayout._hoverlayer.node(),\n                    outerContainer: fullLayout._paper.node(),\n                    gd: gd\n                });\n            }\n        }\n    }\n}\n\n/**\n * Handle path mouseout\n * @param {PathViewModel} d\n */\nfunction mouseoutPath(d) {\n    if(!d.parcatsViewModel.dragDimension) {\n        // We're not currently dragging\n        stylePathsNoHover(d3.select(this));\n\n        // Remove and hover label\n        Fx.loneUnhover(d.parcatsViewModel.graphDiv._fullLayout._hoverlayer.node());\n\n        // Restore path order\n        d.parcatsViewModel.pathSelection.sort(compareRawColor);\n\n        // Emit unhover event\n        if(d.parcatsViewModel.hoverinfoItems.indexOf('skip') === -1) {\n            var points = buildPointsArrayForPath(d);\n            d.parcatsViewModel.graphDiv.emit('plotly_unhover', {points: points, event: d3.event});\n        }\n    }\n}\n\n/**\n * Build array of point objects for a path\n *\n * For use in click/hover events\n * @param {PathViewModel} d\n */\nfunction buildPointsArrayForPath(d) {\n    var points = [];\n    var curveNumber = getTraceIndex(d.parcatsViewModel);\n\n    for(var i = 0; i < d.model.valueInds.length; i++) {\n        var pointNumber = d.model.valueInds[i];\n        points.push({\n            curveNumber: curveNumber,\n            pointNumber: pointNumber\n        });\n    }\n    return points;\n}\n\n/**\n * Handle path click\n * @param {PathViewModel} d\n */\nfunction clickPath(d) {\n    if(d.parcatsViewModel.hoverinfoItems.indexOf('skip') === -1) {\n        // hoverinfo it's skip, so interaction events aren't disabled\n        var points = buildPointsArrayForPath(d);\n        d.parcatsViewModel.graphDiv.emit('plotly_click', {points: points, event: d3.event});\n    }\n}\n\nfunction stylePathsNoHover(pathSelection) {\n    pathSelection\n        .attr('fill', function(d) {\n            return d.model.color;\n        })\n        .attr('fill-opacity', 0.6)\n        .attr('stroke', 'lightgray')\n        .attr('stroke-width', 0.2)\n        .attr('stroke-opacity', 1.0);\n}\n\nfunction stylePathsHover(pathSelection) {\n    pathSelection\n        .attr('fill-opacity', 0.8)\n        .attr('stroke', function(d) {\n            return tinycolor.mostReadable(d.model.color, ['black', 'white']);\n        })\n        .attr('stroke-width', 0.3);\n}\n\nfunction styleCategoryHover(categorySelection) {\n    categorySelection\n        .select('rect.catrect')\n        .attr('stroke', 'black')\n        .attr('stroke-width', 2.5);\n}\n\nfunction styleCategoriesNoHover(categorySelection) {\n    categorySelection\n        .select('rect.catrect')\n        .attr('stroke', 'black')\n        .attr('stroke-width', 1)\n        .attr('stroke-opacity', 1);\n}\n\nfunction styleBandsHover(bandsSelection) {\n    bandsSelection\n        .attr('stroke', 'black')\n        .attr('stroke-width', 1.5);\n}\n\nfunction styleBandsNoHover(bandsSelection) {\n    bandsSelection\n        .attr('stroke', 'black')\n        .attr('stroke-width', 0.2)\n        .attr('stroke-opacity', 1.0)\n        .attr('fill-opacity', 1.0);\n}\n\n/**\n * Return selection of all paths that pass through the specified category\n * @param {CategoryBandViewModel} catBandViewModel\n */\nfunction selectPathsThroughCategoryBandColor(catBandViewModel) {\n\n    var allPaths = catBandViewModel.parcatsViewModel.pathSelection;\n    var dimInd = catBandViewModel.categoryViewModel.model.dimensionInd;\n    var catInd = catBandViewModel.categoryViewModel.model.categoryInd;\n\n    return allPaths\n        .filter(\n            /** @param {PathViewModel} pathViewModel */\n            function(pathViewModel) {\n                return pathViewModel.model.categoryInds[dimInd] === catInd &&\n                    pathViewModel.model.color === catBandViewModel.color;\n            });\n}\n\n\n/**\n * Perform hover styling for all paths that pass though the specified band element's category\n *\n * @param {HTMLElement} bandElement\n *  HTML element for band\n *\n */\nfunction styleForCategoryHovermode(bandElement) {\n\n    // Get all bands in the current category\n    var bandSel = d3.select(bandElement.parentNode).selectAll('rect.bandrect');\n\n    // Raise and style paths\n    bandSel.each(function(bvm) {\n        var paths = selectPathsThroughCategoryBandColor(bvm);\n        stylePathsHover(paths);\n        paths.each(function() {\n            // Raise path to top\n            Lib.raiseToTop(this);\n        });\n    });\n\n    // Style category\n    styleCategoryHover(d3.select(bandElement.parentNode));\n}\n\n/**\n * Perform hover styling for all paths that pass though the category of the specified band element and share the\n * same color\n *\n * @param {HTMLElement} bandElement\n *  HTML element for band\n *\n */\nfunction styleForColorHovermode(bandElement) {\n    var bandViewModel = d3.select(bandElement).datum();\n    var catPaths = selectPathsThroughCategoryBandColor(bandViewModel);\n    stylePathsHover(catPaths);\n    catPaths.each(function() {\n        // Raise path to top\n        Lib.raiseToTop(this);\n    });\n\n    // Style category for drag\n    d3.select(bandElement.parentNode)\n        .selectAll('rect.bandrect')\n        .filter(function(b) {return b.color === bandViewModel.color;})\n        .each(function() {\n            Lib.raiseToTop(this);\n            styleBandsHover(d3.select(this));\n        });\n}\n\n\n/**\n * @param {HTMLElement} bandElement\n *  HTML element for band\n * @param eventName\n *  Event name (plotly_hover or plotly_click)\n * @param event\n *  Mouse Event\n */\nfunction emitPointsEventCategoryHovermode(bandElement, eventName, event) {\n    // Get all bands in the current category\n    var bandViewModel = d3.select(bandElement).datum();\n    var gd = bandViewModel.parcatsViewModel.graphDiv;\n    var bandSel = d3.select(bandElement.parentNode).selectAll('rect.bandrect');\n\n    var points = [];\n    bandSel.each(function(bvm) {\n        var paths = selectPathsThroughCategoryBandColor(bvm);\n        paths.each(function(pathViewModel) {\n            // Extend points array\n            Array.prototype.push.apply(points, buildPointsArrayForPath(pathViewModel));\n        });\n    });\n\n    gd.emit(eventName, {points: points, event: event});\n}\n\n/**\n * @param {HTMLElement} bandElement\n *  HTML element for band\n * @param eventName\n *  Event name (plotly_hover or plotly_click)\n * @param event\n *  Mouse Event\n */\nfunction emitPointsEventColorHovermode(bandElement, eventName, event) {\n    var bandViewModel = d3.select(bandElement).datum();\n    var gd = bandViewModel.parcatsViewModel.graphDiv;\n    var paths = selectPathsThroughCategoryBandColor(bandViewModel);\n\n    var points = [];\n    paths.each(function(pathViewModel) {\n        // Extend points array\n        Array.prototype.push.apply(points, buildPointsArrayForPath(pathViewModel));\n    });\n\n    gd.emit(eventName, {points: points, event: event});\n}\n\n/**\n * Create hover label for a band element's category (for use when hoveron === 'category')\n *\n * @param {ClientRect} rootBBox\n *  Client bounding box for root of figure\n * @param {HTMLElement} bandElement\n *  HTML element for band\n *\n */\nfunction createHoverLabelForCategoryHovermode(rootBBox, bandElement) {\n    // Selections\n    var rectSelection = d3.select(bandElement.parentNode).select('rect.catrect');\n    var rectBoundingBox = rectSelection.node().getBoundingClientRect();\n\n    // Models\n    /** @type {CategoryViewModel} */\n    var catViewModel = rectSelection.datum();\n    var parcatsViewModel = catViewModel.parcatsViewModel;\n    var dimensionModel = parcatsViewModel.model.dimensions[catViewModel.model.dimensionInd];\n\n    // Positions\n    var hoverCenterY = rectBoundingBox.top + rectBoundingBox.height / 2;\n    var hoverCenterX,\n        hoverLabelIdealAlign;\n\n    if(parcatsViewModel.dimensions.length > 1 &&\n        dimensionModel.displayInd === parcatsViewModel.dimensions.length - 1) {\n\n        // right most dimension\n        hoverCenterX = rectBoundingBox.left;\n        hoverLabelIdealAlign = 'left';\n    } else {\n        hoverCenterX = rectBoundingBox.left + rectBoundingBox.width;\n        hoverLabelIdealAlign = 'right';\n    }\n\n    // Hover label text\n    var hoverinfoParts = [];\n    if(catViewModel.parcatsViewModel.hoverinfoItems.indexOf('count') !== -1) {\n        hoverinfoParts.push(['Count:', catViewModel.model.count].join(' '));\n    }\n    if(catViewModel.parcatsViewModel.hoverinfoItems.indexOf('probability') !== -1) {\n        hoverinfoParts.push([\n            'P(' + catViewModel.model.categoryLabel + '):',\n            (catViewModel.model.count / catViewModel.parcatsViewModel.model.count).toFixed(3)].join(' '));\n    }\n\n    var hovertext = hoverinfoParts.join('<br>');\n    return {\n        x: hoverCenterX - rootBBox.left,\n        y: hoverCenterY - rootBBox.top,\n        text: hovertext,\n        color: 'lightgray',\n        borderColor: 'black',\n        fontFamily: 'Monaco, \"Courier New\", monospace',\n        fontSize: 12,\n        fontColor: 'black',\n        idealAlign: hoverLabelIdealAlign\n    };\n}\n\n/**\n * Create hover label for a band element's category (for use when hoveron === 'category')\n *\n * @param {ClientRect} rootBBox\n *  Client bounding box for root of figure\n * @param {HTMLElement} bandElement\n *  HTML element for band\n *\n */\nfunction createHoverLabelForDimensionHovermode(rootBBox, bandElement) {\n\n    var allHoverlabels = [];\n\n    d3.select(bandElement.parentNode.parentNode)\n        .selectAll('g.category')\n        .select('rect.catrect')\n        .each(function() {\n            var bandNode = this;\n            allHoverlabels.push(createHoverLabelForCategoryHovermode(rootBBox, bandNode));\n        });\n\n    return allHoverlabels;\n}\n\n/**\n * Create hover labels for a band element's category (for use when hoveron === 'dimension')\n *\n * @param {ClientRect} rootBBox\n *  Client bounding box for root of figure\n * @param {HTMLElement} bandElement\n *  HTML element for band\n *\n */\nfunction createHoverLabelForColorHovermode(rootBBox, bandElement) {\n\n    var bandBoundingBox = bandElement.getBoundingClientRect();\n\n    // Models\n    /** @type {CategoryBandViewModel} */\n    var bandViewModel = d3.select(bandElement).datum();\n    var catViewModel = bandViewModel.categoryViewModel;\n    var parcatsViewModel = catViewModel.parcatsViewModel;\n    var dimensionModel = parcatsViewModel.model.dimensions[catViewModel.model.dimensionInd];\n\n    // positions\n    var hoverCenterY = bandBoundingBox.y + bandBoundingBox.height / 2;\n\n    var hoverCenterX,\n        hoverLabelIdealAlign;\n    if(parcatsViewModel.dimensions.length > 1 &&\n        dimensionModel.displayInd === parcatsViewModel.dimensions.length - 1) {\n        // right most dimension\n        hoverCenterX = bandBoundingBox.left;\n        hoverLabelIdealAlign = 'left';\n    } else {\n        hoverCenterX = bandBoundingBox.left + bandBoundingBox.width;\n        hoverLabelIdealAlign = 'right';\n    }\n\n    // Labels\n    var catLabel = catViewModel.model.categoryLabel;\n\n    // Counts\n    var totalCount = bandViewModel.parcatsViewModel.model.count;\n\n    var bandColorCount = 0;\n    bandViewModel.categoryViewModel.bands.forEach(function(b) {\n        if(b.color === bandViewModel.color) {\n            bandColorCount += b.count;\n        }\n    });\n\n    var catCount = catViewModel.model.count;\n\n    var colorCount = 0;\n    parcatsViewModel.pathSelection.each(\n        /** @param {PathViewModel} pathViewModel */\n        function(pathViewModel) {\n            if(pathViewModel.model.color === bandViewModel.color) {\n                colorCount += pathViewModel.model.count;\n            }\n        });\n\n    // Hover label text\n    var hoverinfoParts = [];\n    if(catViewModel.parcatsViewModel.hoverinfoItems.indexOf('count') !== -1) {\n        hoverinfoParts.push(['Count:', bandColorCount].join(' '));\n    }\n    if(catViewModel.parcatsViewModel.hoverinfoItems.indexOf('probability') !== -1) {\n        var pColorAndCatLable = 'P(color ∩ ' + catLabel + '): ';\n        var pColorAndCatValue = (bandColorCount / totalCount).toFixed(3);\n        var pColorAndCatRow = pColorAndCatLable + pColorAndCatValue;\n        hoverinfoParts.push(pColorAndCatRow);\n\n        var pCatGivenColorLabel = 'P(' + catLabel + ' | color): ';\n        var pCatGivenColorValue = (bandColorCount / colorCount).toFixed(3);\n        var pCatGivenColorRow = pCatGivenColorLabel + pCatGivenColorValue;\n        hoverinfoParts.push(pCatGivenColorRow);\n\n        var pColorGivenCatLabel = 'P(color | ' + catLabel + '): ';\n        var pColorGivenCatValue = (bandColorCount / catCount).toFixed(3);\n        var pColorGivenCatRow = pColorGivenCatLabel + pColorGivenCatValue;\n        hoverinfoParts.push(pColorGivenCatRow);\n    }\n\n    var hovertext = hoverinfoParts.join('<br>');\n\n    // Compute text color\n    var textColor = tinycolor.mostReadable(bandViewModel.color, ['black', 'white']);\n\n    return {\n        x: hoverCenterX - rootBBox.left,\n        y: hoverCenterY - rootBBox.top,\n        // name: 'NAME',\n        text: hovertext,\n        color: bandViewModel.color,\n        borderColor: 'black',\n        fontFamily: 'Monaco, \"Courier New\", monospace',\n        fontColor: textColor,\n        fontSize: 10,\n        idealAlign: hoverLabelIdealAlign\n    };\n}\n\n/**\n * Handle dimension mouseover\n * @param {CategoryBandViewModel} bandViewModel\n */\nfunction mouseoverCategoryBand(bandViewModel) {\n    if(!bandViewModel.parcatsViewModel.dragDimension) {\n        // We're not currently dragging\n\n        if(bandViewModel.parcatsViewModel.hoverinfoItems.indexOf('skip') === -1) {\n            // hoverinfo is not skip, so we at least style the bands and emit interaction events\n\n            // Mouse\n            var mouseY = d3.mouse(this)[1];\n            if(mouseY < -1) {\n                // Hover is above above the category rectangle (probably the dimension title text)\n                return;\n            }\n\n            var gd = bandViewModel.parcatsViewModel.graphDiv;\n            var fullLayout = gd._fullLayout;\n            var rootBBox = fullLayout._paperdiv.node().getBoundingClientRect();\n            var hoveron = bandViewModel.parcatsViewModel.hoveron;\n\n            /** @type {HTMLElement} */\n            var bandElement = this;\n\n            // Handle style and events\n            if(hoveron === 'color') {\n                styleForColorHovermode(bandElement);\n                emitPointsEventColorHovermode(bandElement, 'plotly_hover', d3.event);\n            } else {\n                styleForCategoryHovermode(bandElement);\n                emitPointsEventCategoryHovermode(bandElement, 'plotly_hover', d3.event);\n            }\n\n            // Handle hover label\n            if(bandViewModel.parcatsViewModel.hoverinfoItems.indexOf('none') === -1) {\n                var hoverItems;\n                if(hoveron === 'category') {\n                    hoverItems = createHoverLabelForCategoryHovermode(rootBBox, bandElement);\n                } else if(hoveron === 'color') {\n                    hoverItems = createHoverLabelForColorHovermode(rootBBox, bandElement);\n                } else if(hoveron === 'dimension') {\n                    hoverItems = createHoverLabelForDimensionHovermode(rootBBox, bandElement);\n                }\n\n                if(hoverItems) {\n                    Fx.multiHovers(hoverItems, {\n                        container: fullLayout._hoverlayer.node(),\n                        outerContainer: fullLayout._paper.node(),\n                        gd: gd\n                    });\n                }\n            }\n        }\n    }\n}\n\n\n/**\n * Handle dimension mouseover\n * @param {CategoryBandViewModel} bandViewModel\n */\nfunction mouseoutCategory(bandViewModel) {\n\n    var parcatsViewModel = bandViewModel.parcatsViewModel;\n\n    if(!parcatsViewModel.dragDimension) {\n        // We're not dragging anything\n\n        // Reset unhovered styles\n        stylePathsNoHover(parcatsViewModel.pathSelection);\n        styleCategoriesNoHover(parcatsViewModel.dimensionSelection.selectAll('g.category'));\n        styleBandsNoHover(parcatsViewModel.dimensionSelection.selectAll('g.category').selectAll('rect.bandrect'));\n\n        // Remove hover label\n        Fx.loneUnhover(parcatsViewModel.graphDiv._fullLayout._hoverlayer.node());\n\n        // Restore path order\n        parcatsViewModel.pathSelection.sort(compareRawColor);\n\n        // Emit unhover event\n        if(parcatsViewModel.hoverinfoItems.indexOf('skip') === -1) {\n\n            var hoveron = bandViewModel.parcatsViewModel.hoveron;\n            var bandElement = this;\n\n            // Handle style and events\n            if(hoveron === 'color') {\n                emitPointsEventColorHovermode(bandElement, 'plotly_unhover', d3.event);\n            } else {\n                emitPointsEventCategoryHovermode(bandElement, 'plotly_unhover', d3.event);\n            }\n        }\n    }\n}\n\n\n/**\n * Handle dimension drag start\n * @param {DimensionViewModel} d\n */\nfunction dragDimensionStart(d) {\n\n    // Check if dragging is supported\n    if(d.parcatsViewModel.arrangement === 'fixed') {\n        return;\n    }\n\n    // Save off initial drag indexes for dimension\n    d.dragDimensionDisplayInd = d.model.displayInd;\n    d.initialDragDimensionDisplayInds = d.parcatsViewModel.model.dimensions.map(function(d) {return d.displayInd;});\n    d.dragHasMoved = false;\n\n    // Check for category hit\n    d.dragCategoryDisplayInd = null;\n    d3.select(this)\n        .selectAll('g.category')\n        .select('rect.catrect')\n        .each(\n            /** @param {CategoryViewModel} catViewModel */\n            function(catViewModel) {\n                var catMouseX = d3.mouse(this)[0];\n                var catMouseY = d3.mouse(this)[1];\n\n\n                if(-2 <= catMouseX && catMouseX <= catViewModel.width + 2 &&\n                    -2 <= catMouseY && catMouseY <= catViewModel.height + 2) {\n\n                    // Save off initial drag indexes for categories\n                    d.dragCategoryDisplayInd = catViewModel.model.displayInd;\n                    d.initialDragCategoryDisplayInds = d.model.categories.map(function(c) {\n                        return c.displayInd;\n                    });\n\n                    // Initialize categories dragY to be the current y position\n                    catViewModel.model.dragY = catViewModel.y;\n\n                    // Raise category\n                    Lib.raiseToTop(this.parentNode);\n\n                    // Get band element\n                    d3.select(this.parentNode)\n                        .selectAll('rect.bandrect')\n                        /** @param {CategoryBandViewModel} bandViewModel */\n                        .each(function(bandViewModel) {\n                            if(bandViewModel.y < catMouseY && catMouseY <= bandViewModel.y + bandViewModel.height) {\n                                d.potentialClickBand = this;\n                            }\n                        });\n                }\n            });\n\n    // Update toplevel drag dimension\n    d.parcatsViewModel.dragDimension = d;\n\n    // Remove hover label if any\n    Fx.loneUnhover(d.parcatsViewModel.graphDiv._fullLayout._hoverlayer.node());\n}\n\n/**\n * Handle dimension drag\n * @param {DimensionViewModel} d\n */\nfunction dragDimension(d) {\n\n    // Check if dragging is supported\n    if(d.parcatsViewModel.arrangement === 'fixed') {\n        return;\n    }\n\n    d.dragHasMoved = true;\n\n    if(d.dragDimensionDisplayInd === null) {\n        return;\n    }\n\n    var dragDimInd = d.dragDimensionDisplayInd;\n    var prevDimInd = dragDimInd - 1;\n    var nextDimInd = dragDimInd + 1;\n\n    var dragDimension = d.parcatsViewModel\n        .dimensions[dragDimInd];\n\n    // Update category\n    if(d.dragCategoryDisplayInd !== null) {\n\n        var dragCategory = dragDimension.categories[d.dragCategoryDisplayInd];\n\n        // Update dragY by dy\n        dragCategory.model.dragY += d3.event.dy;\n        var categoryY = dragCategory.model.dragY;\n\n        // Check for category drag swaps\n        var catDisplayInd = dragCategory.model.displayInd;\n        var dimCategoryViews = dragDimension.categories;\n\n        var catAbove = dimCategoryViews[catDisplayInd - 1];\n        var catBelow = dimCategoryViews[catDisplayInd + 1];\n\n        // Check for overlap above\n        if(catAbove !== undefined) {\n\n            if(categoryY < (catAbove.y + catAbove.height / 2.0)) {\n\n                // Swap display inds\n                dragCategory.model.displayInd = catAbove.model.displayInd;\n                catAbove.model.displayInd = catDisplayInd;\n            }\n        }\n\n        if(catBelow !== undefined) {\n\n            if((categoryY + dragCategory.height) > (catBelow.y + catBelow.height / 2.0)) {\n\n                // Swap display inds\n                dragCategory.model.displayInd = catBelow.model.displayInd;\n                catBelow.model.displayInd = catDisplayInd;\n            }\n        }\n\n        // Update category drag display index\n        d.dragCategoryDisplayInd = dragCategory.model.displayInd;\n    }\n\n    // Update dimension position\n    if(d.dragCategoryDisplayInd === null || d.parcatsViewModel.arrangement === 'freeform') {\n        dragDimension.model.dragX = d3.event.x;\n\n        // Check for dimension swaps\n        var prevDimension = d.parcatsViewModel.dimensions[prevDimInd];\n        var nextDimension = d.parcatsViewModel.dimensions[nextDimInd];\n\n        if(prevDimension !== undefined) {\n            if(dragDimension.model.dragX < (prevDimension.x + prevDimension.width)) {\n\n                // Swap display inds\n                dragDimension.model.displayInd = prevDimension.model.displayInd;\n                prevDimension.model.displayInd = dragDimInd;\n            }\n        }\n\n        if(nextDimension !== undefined) {\n            if((dragDimension.model.dragX + dragDimension.width) > nextDimension.x) {\n\n                // Swap display inds\n                dragDimension.model.displayInd = nextDimension.model.displayInd;\n                nextDimension.model.displayInd = d.dragDimensionDisplayInd;\n            }\n        }\n\n        // Update drag display index\n        d.dragDimensionDisplayInd = dragDimension.model.displayInd;\n    }\n\n    // Update view models\n    updateDimensionViewModels(d.parcatsViewModel);\n    updatePathViewModels(d.parcatsViewModel);\n\n    // Update svg geometry\n    updateSvgCategories(d.parcatsViewModel);\n    updateSvgPaths(d.parcatsViewModel);\n}\n\n\n/**\n * Handle dimension drag end\n * @param {DimensionViewModel} d\n */\nfunction dragDimensionEnd(d) {\n\n    // Check if dragging is supported\n    if(d.parcatsViewModel.arrangement === 'fixed') {\n        return;\n    }\n\n    if(d.dragDimensionDisplayInd === null) {\n        return;\n    }\n\n    d3.select(this).selectAll('text').attr('font-weight', 'normal');\n\n    // Compute restyle command\n    // -----------------------\n    var restyleData = {};\n    var traceInd = getTraceIndex(d.parcatsViewModel);\n\n    // ### Handle dimension reordering ###\n    var finalDragDimensionDisplayInds = d.parcatsViewModel.model.dimensions.map(function(d) {return d.displayInd;});\n    var anyDimsReordered = d.initialDragDimensionDisplayInds.some(function(initDimDisplay, dimInd) {\n        return initDimDisplay !== finalDragDimensionDisplayInds[dimInd];\n    });\n\n    if(anyDimsReordered) {\n        finalDragDimensionDisplayInds.forEach(function(finalDimDisplay, dimInd) {\n            var containerInd = d.parcatsViewModel.model.dimensions[dimInd].containerInd;\n            restyleData['dimensions[' + containerInd + '].displayindex'] = finalDimDisplay;\n        });\n    }\n\n    // ### Handle category reordering ###\n    var anyCatsReordered = false;\n    if(d.dragCategoryDisplayInd !== null) {\n        var finalDragCategoryDisplayInds = d.model.categories.map(function(c) {\n            return c.displayInd;\n        });\n\n        anyCatsReordered = d.initialDragCategoryDisplayInds.some(function(initCatDisplay, catInd) {\n            return initCatDisplay !== finalDragCategoryDisplayInds[catInd];\n        });\n\n        if(anyCatsReordered) {\n\n            // Sort a shallow copy of the category models by display index\n            var sortedCategoryModels = d.model.categories.slice().sort(\n                function(a, b) { return a.displayInd - b.displayInd; });\n\n            // Get new categoryarray and ticktext values\n            var newCategoryArray = sortedCategoryModels.map(function(v) { return v.categoryValue; });\n            var newCategoryLabels = sortedCategoryModels.map(function(v) { return v.categoryLabel; });\n\n            restyleData['dimensions[' + d.model.containerInd + '].categoryarray'] = [newCategoryArray];\n            restyleData['dimensions[' + d.model.containerInd + '].ticktext'] = [newCategoryLabels];\n            restyleData['dimensions[' + d.model.containerInd + '].categoryorder'] = 'array';\n        }\n    }\n\n    // Handle potential click event\n    // ----------------------------\n    if(d.parcatsViewModel.hoverinfoItems.indexOf('skip') === -1) {\n        if(!d.dragHasMoved && d.potentialClickBand) {\n            if(d.parcatsViewModel.hoveron === 'color') {\n                emitPointsEventColorHovermode(d.potentialClickBand, 'plotly_click', d3.event.sourceEvent);\n            } else {\n                emitPointsEventCategoryHovermode(d.potentialClickBand, 'plotly_click', d3.event.sourceEvent);\n            }\n        }\n    }\n\n    // Nullify drag states\n    // -------------------\n    d.model.dragX = null;\n    if(d.dragCategoryDisplayInd !== null) {\n        var dragCategory = d.parcatsViewModel\n            .dimensions[d.dragDimensionDisplayInd]\n            .categories[d.dragCategoryDisplayInd];\n\n        dragCategory.model.dragY = null;\n        d.dragCategoryDisplayInd = null;\n    }\n\n    d.dragDimensionDisplayInd = null;\n    d.parcatsViewModel.dragDimension = null;\n    d.dragHasMoved = null;\n    d.potentialClickBand = null;\n\n    // Update view models\n    // ------------------\n    updateDimensionViewModels(d.parcatsViewModel);\n    updatePathViewModels(d.parcatsViewModel);\n\n    // Perform transition\n    // ------------------\n    var transition = d3.transition()\n        .duration(300)\n        .ease('cubic-in-out');\n\n    transition\n        .each(function() {\n            updateSvgCategories(d.parcatsViewModel, true);\n            updateSvgPaths(d.parcatsViewModel, true);\n        })\n        .each('end', function() {\n            if(anyDimsReordered || anyCatsReordered) {\n                // Perform restyle if the order of categories or dimensions changed\n                Plotly.restyle(d.parcatsViewModel.graphDiv, restyleData, [traceInd]);\n            }\n        });\n}\n\n/**\n *\n * @param {ParcatsViewModel} parcatsViewModel\n */\nfunction getTraceIndex(parcatsViewModel) {\n    var traceInd;\n    var allTraces = parcatsViewModel.graphDiv._fullData;\n    for(var i = 0; i < allTraces.length; i++) {\n        if(parcatsViewModel.key === allTraces[i].uid) {\n            traceInd = i;\n            break;\n        }\n    }\n    return traceInd;\n}\n\n/** Update the svg paths for view model\n * @param {ParcatsViewModel} parcatsViewModel\n * @param {boolean} hasTransition Whether to update element with transition\n */\nfunction updateSvgPaths(parcatsViewModel, hasTransition) {\n\n    if(hasTransition === undefined) {\n        hasTransition = false;\n    }\n\n    function transition(selection) {\n        return hasTransition ? selection.transition() : selection;\n    }\n\n    // Update binding\n    parcatsViewModel.pathSelection.data(function(d) {\n        return d.paths;\n    }, key);\n\n    // Update paths\n    transition(parcatsViewModel.pathSelection).attr('d', function(d) {\n        return d.svgD;\n    });\n}\n\n/** Update the svg paths for view model\n * @param {ParcatsViewModel} parcatsViewModel\n * @param {boolean} hasTransition Whether to update element with transition\n */\nfunction updateSvgCategories(parcatsViewModel, hasTransition) {\n\n    if(hasTransition === undefined) {\n        hasTransition = false;\n    }\n\n    function transition(selection) {\n        return hasTransition ? selection.transition() : selection;\n    }\n\n    // Update binding\n    parcatsViewModel.dimensionSelection\n        .data(function(d) {\n            return d.dimensions;}, key);\n\n    var categorySelection = parcatsViewModel.dimensionSelection\n        .selectAll('g.category')\n        .data(function(d) {return d.categories;}, key);\n\n    // Update dimension position\n    transition(parcatsViewModel.dimensionSelection)\n        .attr('transform', function(d) {\n            return 'translate(' + d.x + ', 0)';\n        });\n\n    // Update category position\n    transition(categorySelection)\n        .attr('transform', function(d) {\n            return 'translate(0, ' + d.y + ')';\n        });\n\n    var dimLabelSelection = categorySelection.select('.dimlabel');\n\n    // ### Update dimension label\n    // Only the top-most display category should have the dimension label\n    dimLabelSelection\n        .text(function(d, i) {\n            if(i === 0) {\n                // Add dimension label above topmost category\n                return d.parcatsViewModel.model.dimensions[d.model.dimensionInd].dimensionLabel;\n            } else {\n                return null;\n            }\n        });\n\n    // Update category label\n    // Categories in the right-most display dimension have their labels on\n    // the right, all others on the left\n    var catLabelSelection = categorySelection.select('.catlabel');\n    catLabelSelection\n        .attr('text-anchor',\n            function(d) {\n                if(catInRightDim(d)) {\n                    // Place label to the right of category\n                    return 'start';\n                } else {\n                    // Place label to the left of category\n                    return 'end';\n                }\n            })\n        .attr('x',\n            function(d) {\n                if(catInRightDim(d)) {\n                    // Place label to the right of category\n                    return d.width + 5;\n                } else {\n                    // Place label to the left of category\n                    return -5;\n                }\n            })\n        .each(function(d) {\n            // Update attriubutes of <tspan> elements\n            var newX;\n            var newAnchor;\n            if(catInRightDim(d)) {\n                // Place label to the right of category\n                newX = d.width + 5;\n                newAnchor = 'start';\n            } else {\n                // Place label to the left of category\n                newX = -5;\n                newAnchor = 'end';\n            }\n            d3.select(this)\n                .selectAll('tspan')\n                .attr('x', newX)\n                .attr('text-anchor', newAnchor);\n        });\n\n    // Update bands\n    // Initialize color band rects\n    var bandSelection = categorySelection\n        .selectAll('rect.bandrect')\n        .data(\n            /** @param {CategoryViewModel} catViewModel*/\n            function(catViewModel) {\n                return catViewModel.bands;\n            }, key);\n\n    var bandsSelectionEnter = bandSelection.enter()\n        .append('rect')\n        .attr('class', 'bandrect')\n        .attr('cursor', 'move')\n        .attr('stroke-opacity', 0)\n        .attr('fill', function(d) {\n            return d.color;\n        })\n        .attr('fill-opacity', 0);\n\n    bandSelection\n        .attr('fill', function(d) {\n            return d.color;\n        })\n        .attr('width', function(d) {\n            return d.width;\n        })\n        .attr('height', function(d) {\n            return d.height;\n        })\n        .attr('y', function(d) {\n            return d.y;\n        });\n\n    styleBandsNoHover(bandsSelectionEnter);\n\n    // Raise bands to the top\n    bandSelection.each(function() {Lib.raiseToTop(this);});\n\n    // Remove unused bands\n    bandSelection.exit().remove();\n}\n\n/**\n * Create a ParcatsViewModel traces\n * @param {Object} graphDiv\n *  Top-level graph div element\n * @param {Layout} layout\n *  SVG layout object\n * @param {Array.<ParcatsModel>} wrappedParcatsModel\n *  Wrapped ParcatsModel for this trace\n * @return {ParcatsViewModel}\n */\nfunction createParcatsViewModel(graphDiv, layout, wrappedParcatsModel) {\n    // Unwrap model\n    var parcatsModel = wrappedParcatsModel[0];\n\n    // Compute margin\n    var margin = layout.margin || {l: 80, r: 80, t: 100, b: 80};\n\n    // Compute pixel position/extents\n    var trace = parcatsModel.trace;\n    var domain = trace.domain;\n    var figureWidth = layout.width;\n    var figureHeight = layout.height;\n    var traceWidth = Math.floor(figureWidth * (domain.x[1] - domain.x[0]));\n    var traceHeight = Math.floor(figureHeight * (domain.y[1] - domain.y[0]));\n    var traceX = domain.x[0] * figureWidth + margin.l;\n    var traceY = layout.height - domain.y[1] * layout.height + margin.t;\n\n    // Handle path shape\n    // -----------------\n    var pathShape = trace.line.shape;\n\n    // Handle hover info\n    // -----------------\n    var hoverinfoItems;\n    if(trace.hoverinfo === 'all') {\n        hoverinfoItems = ['count', 'probability'];\n    } else {\n        hoverinfoItems = trace.hoverinfo.split('+');\n    }\n\n    // Construct parcatsViewModel\n    // --------------------------\n    var parcatsViewModel = {\n        key: trace.uid,\n        model: parcatsModel,\n        x: traceX,\n        y: traceY,\n        width: traceWidth,\n        height: traceHeight,\n        hoveron: trace.hoveron,\n        hoverinfoItems: hoverinfoItems,\n        arrangement: trace.arrangement,\n        bundlecolors: trace.bundlecolors,\n        sortpaths: trace.sortpaths,\n        labelfont: trace.labelfont,\n        categorylabelfont: trace.tickfont,\n        pathShape: pathShape,\n        dragDimension: null,\n        margin: margin,\n        paths: [],\n        dimensions: [],\n        graphDiv: graphDiv,\n        traceSelection: null,\n        pathSelection: null,\n        dimensionSelection: null\n    };\n\n    // Update dimension view models if we have at least 1 dimension\n    if(parcatsModel.dimensions) {\n        updateDimensionViewModels(parcatsViewModel);\n\n        // Update path view models if we have at least 2 dimensions\n        updatePathViewModels(parcatsViewModel);\n    }\n    // Inside a categories view model\n    return parcatsViewModel;\n}\n\n/**\n * Build the SVG string to represents a parallel categories path\n * @param {Array.<Number>} leftXPositions\n *  Array of the x positions of the left edge of each dimension (in display order)\n * @param {Array.<Number>} pathYs\n *  Array of the y positions of the top of the path at each dimension (in display order)\n * @param {Array.<Number>} dimWidths\n *  Array of the widths of each dimension in display order\n * @param {Number} pathHeight\n *  The height of the path in pixels\n * @param {Number} curvature\n *  The curvature factor for the path. 0 results in a straight line and values greater than zero result in curved paths\n * @return {string}\n */\nfunction buildSvgPath(leftXPositions, pathYs, dimWidths, pathHeight, curvature) {\n\n    // Compute the x midpoint of each path segment\n    var xRefPoints1 = [];\n    var xRefPoints2 = [];\n    var refInterpolator;\n    var d;\n\n    for(d = 0; d < dimWidths.length - 1; d++) {\n        refInterpolator = d3.interpolateNumber(dimWidths[d] + leftXPositions[d], leftXPositions[d + 1]);\n        xRefPoints1.push(refInterpolator(curvature));\n        xRefPoints2.push(refInterpolator(1 - curvature));\n    }\n\n    // Move to top of path on left edge of left-most category\n    var svgD = 'M ' + leftXPositions[0] + ',' + pathYs[0];\n\n    // Horizontal line to right edge\n    svgD += 'l' + dimWidths[0] + ',0 ';\n\n    // Horizontal line to right edge\n    for(d = 1; d < dimWidths.length; d++) {\n\n        // Curve to left edge of category\n        svgD += 'C' + xRefPoints1[d - 1] + ',' + pathYs[d - 1] +\n              ' ' + xRefPoints2[d - 1] + ',' + pathYs[d] +\n              ' ' + leftXPositions[d] + ',' + pathYs[d];\n\n        // svgD += 'L' + leftXPositions[d] + ',' + pathYs[d];\n\n        // Horizontal line to right edge\n        svgD += 'l' + dimWidths[d] + ',0 ';\n    }\n\n    // Line down\n    svgD += 'l' + '0,' + pathHeight + ' ';\n\n    // Line to left edge of right-most category\n    svgD += 'l -' + dimWidths[dimWidths.length - 1] + ',0 ';\n\n    for(d = dimWidths.length - 2; d >= 0; d--) {\n\n        // Curve to right edge of category\n        svgD += 'C' + xRefPoints2[d] + ',' + (pathYs[d + 1] + pathHeight) +\n             ' ' + xRefPoints1[d] + ',' + (pathYs[d] + pathHeight) +\n             ' ' + (leftXPositions[d] + dimWidths[d]) + ',' + (pathYs[d] + pathHeight);\n\n        // svgD += 'L' + (leftXPositions[d] + dimWidths[d]) + ',' + (pathYs[d] + pathHeight);\n\n        // Horizontal line to right edge\n        svgD += 'l-' + dimWidths[d] + ',0 ';\n    }\n\n    // Close path\n    svgD += 'Z';\n    return svgD;\n}\n\n/**\n * Update the path view models based on the dimension view models in a ParcatsViewModel\n *\n * @param {ParcatsViewModel} parcatsViewModel\n *  View model for trace\n */\nfunction updatePathViewModels(parcatsViewModel) {\n\n    // Initialize an array of the y position of the top of the next path to be added to each category.\n    //\n    // nextYPositions[d][c] is the y position of the next path through category with index c of dimension with index d\n    var dimensionViewModels = parcatsViewModel.dimensions;\n    var parcatsModel = parcatsViewModel.model;\n    var nextYPositions = dimensionViewModels.map(\n        function(d) {\n            return d.categories.map(\n                function(c) {\n                    return c.y;\n                });\n        });\n\n    // Array from category index to category display index for each true dimension index\n    var catToDisplayIndPerDim = parcatsViewModel.model.dimensions.map(\n        function(d) {\n            return d.categories.map(function(c) {return c.displayInd;});\n        });\n\n    // Array from true dimension index to dimension display index\n    var dimToDisplayInd = parcatsViewModel.model.dimensions.map(function(d) {return d.displayInd;});\n    var displayToDimInd = parcatsViewModel.dimensions.map(function(d) {return d.model.dimensionInd;});\n\n    // Array of the x position of the left edge of the rectangles for each dimension\n    var leftXPositions = dimensionViewModels.map(\n        function(d) {\n            return d.x;\n        });\n\n    // Compute dimension widths\n    var dimWidths = dimensionViewModels.map(function(d) {return d.width;});\n\n    // Build sorted Array of PathModel objects\n    var pathModels = [];\n    for(var p in parcatsModel.paths) {\n        if(parcatsModel.paths.hasOwnProperty(p)) {\n            pathModels.push(parcatsModel.paths[p]);\n        }\n    }\n\n    // Compute category display inds to use for sorting paths\n    function pathDisplayCategoryInds(pathModel) {\n        var dimensionInds = pathModel.categoryInds.map(function(catInd, dimInd) {return catToDisplayIndPerDim[dimInd][catInd];});\n        var displayInds = displayToDimInd.map(function(dimInd) {\n            return dimensionInds[dimInd];\n        });\n        return displayInds;\n    }\n\n    // Sort in ascending order by display index array\n    pathModels.sort(function(v1, v2) {\n\n        // Build display inds for each path\n        var sortArray1 = pathDisplayCategoryInds(v1);\n        var sortArray2 = pathDisplayCategoryInds(v2);\n\n        // Handle path sort order\n        if(parcatsViewModel.sortpaths === 'backward') {\n            sortArray1.reverse();\n            sortArray2.reverse();\n        }\n\n        // Append the first value index of the path to break ties\n        sortArray1.push(v1.valueInds[0]);\n        sortArray2.push(v2.valueInds[0]);\n\n        // Handle color bundling\n        if(parcatsViewModel.bundlecolors) {\n            // Prepend sort array with the raw color value\n            sortArray1.unshift(v1.rawColor);\n            sortArray2.unshift(v2.rawColor);\n        }\n\n        // colors equal, sort by display categories\n        if(sortArray1 < sortArray2) {\n            return -1;\n        }\n        if(sortArray1 > sortArray2) {\n            return 1;\n        }\n\n        return 0;\n    });\n\n    // Create path models\n    var pathViewModels = new Array(pathModels.length);\n    var totalCount = dimensionViewModels[0].model.count;\n    var totalHeight = dimensionViewModels[0].categories\n        .map(function(c) { return c.height; })\n        .reduce(function(v1, v2) { return v1 + v2; });\n\n\n    for(var pathNumber = 0; pathNumber < pathModels.length; pathNumber++) {\n        var pathModel = pathModels[pathNumber];\n\n        var pathHeight;\n        if(totalCount > 0) {\n            pathHeight = totalHeight * (pathModel.count / totalCount);\n        } else {\n            pathHeight = 0;\n        }\n\n        // Build path y coords\n        var pathYs = new Array(nextYPositions.length);\n        for(var d = 0; d < pathModel.categoryInds.length; d++) {\n            var catInd = pathModel.categoryInds[d];\n            var catDisplayInd = catToDisplayIndPerDim[d][catInd];\n            var dimDisplayInd = dimToDisplayInd[d];\n\n            // Update next y position\n            pathYs[dimDisplayInd] = nextYPositions[dimDisplayInd][catDisplayInd];\n            nextYPositions[dimDisplayInd][catDisplayInd] += pathHeight;\n\n            // Update category color information\n            var catViewModle = parcatsViewModel.dimensions[dimDisplayInd].categories[catDisplayInd];\n            var numBands = catViewModle.bands.length;\n            var lastCatBand = catViewModle.bands[numBands - 1];\n\n            if(lastCatBand === undefined || pathModel.rawColor !== lastCatBand.rawColor) {\n                // Create a new band\n                var bandY = lastCatBand === undefined ? 0 : lastCatBand.y + lastCatBand.height;\n                catViewModle.bands.push({\n                    key: bandY,\n                    color: pathModel.color,\n                    rawColor: pathModel.rawColor,\n                    height: pathHeight,\n                    width: catViewModle.width,\n                    count: pathModel.count,\n                    y: bandY,\n                    categoryViewModel: catViewModle,\n                    parcatsViewModel: parcatsViewModel\n                });\n            } else {\n                // Extend current band\n                var currentBand = catViewModle.bands[numBands - 1];\n                currentBand.height += pathHeight;\n                currentBand.count += pathModel.count;\n            }\n        }\n\n        // build svg path\n        var svgD;\n        if(parcatsViewModel.pathShape === 'hspline') {\n            svgD = buildSvgPath(leftXPositions, pathYs, dimWidths, pathHeight, 0.5);\n        } else {\n            svgD = buildSvgPath(leftXPositions, pathYs, dimWidths, pathHeight, 0);\n        }\n\n        pathViewModels[pathNumber] = {\n            key: pathModel.valueInds[0],\n            model: pathModel,\n            height: pathHeight,\n            leftXs: leftXPositions,\n            topYs: pathYs,\n            dimWidths: dimWidths,\n            svgD: svgD,\n            parcatsViewModel: parcatsViewModel\n        };\n    }\n\n    parcatsViewModel.paths = pathViewModels;\n\n // * @property key\n // *  Unique key for this model\n // * @property {PathModel} model\n // *  Source path model\n // * @property {Number} height\n // *  Height of this path (pixels)\n // * @property {String} svgD\n // *  SVG path \"d\" attribute string\n}\n\n/**\n * Update the dimension view models based on the dimension models in a ParcatsViewModel\n *\n * @param {ParcatsViewModel} parcatsViewModel\n *  View model for trace\n */\nfunction updateDimensionViewModels(parcatsViewModel) {\n\n    // Compute dimension ordering\n    var dimensionsIndInfo = parcatsViewModel.model.dimensions.map(function(d) {\n        return {displayInd: d.displayInd, dimensionInd: d.dimensionInd};\n    });\n\n    dimensionsIndInfo.sort(function(a, b) {\n        return a.displayInd - b.displayInd;\n    });\n\n    var dimensions = [];\n    for(var displayInd in dimensionsIndInfo) {\n        var dimensionInd = dimensionsIndInfo[displayInd].dimensionInd;\n        var dimModel = parcatsViewModel.model.dimensions[dimensionInd];\n        dimensions.push(createDimensionViewModel(parcatsViewModel, dimModel));\n    }\n\n    parcatsViewModel.dimensions = dimensions;\n}\n\n/**\n * Create a parcats DimensionViewModel\n *\n * @param {ParcatsViewModel} parcatsViewModel\n *  View model for trace\n * @param {DimensionModel} dimensionModel\n * @return {DimensionViewModel}\n */\nfunction createDimensionViewModel(parcatsViewModel, dimensionModel) {\n\n    // Compute dimension x position\n    var categoryLabelPad = 40;\n    var dimWidth = 16;\n    var numDimensions = parcatsViewModel.model.dimensions.length;\n    var displayInd = dimensionModel.displayInd;\n\n    // Compute x coordinate values\n    var dimDx;\n    var dimX0;\n    var dimX;\n\n    if(numDimensions > 1) {\n        dimDx = (parcatsViewModel.width - 2 * categoryLabelPad - dimWidth) / (numDimensions - 1);\n    } else {\n        dimDx = 0;\n    }\n    dimX0 = categoryLabelPad;\n    dimX = dimX0 + dimDx * displayInd;\n\n    // Compute categories\n    var categories = [];\n    var maxCats = parcatsViewModel.model.maxCats;\n    var numCats = dimensionModel.categories.length;\n    var catSpacing = 8;\n    var totalCount = dimensionModel.count;\n    var totalHeight = parcatsViewModel.height - catSpacing * (maxCats - 1);\n    var nextCatHeight;\n    var nextCatModel;\n    var nextCat;\n    var catInd;\n    var catDisplayInd;\n\n    // Compute starting Y offset\n    var nextCatY = (maxCats - numCats) * catSpacing / 2.0;\n\n    // Compute category ordering\n    var categoryIndInfo = dimensionModel.categories.map(function(c) {\n        return {displayInd: c.displayInd, categoryInd: c.categoryInd};\n    });\n\n    categoryIndInfo.sort(function(a, b) {\n        return a.displayInd - b.displayInd;\n    });\n\n    for(catDisplayInd = 0; catDisplayInd < numCats; catDisplayInd++) {\n        catInd = categoryIndInfo[catDisplayInd].categoryInd;\n        nextCatModel = dimensionModel.categories[catInd];\n\n        if(totalCount > 0) {\n            nextCatHeight = (nextCatModel.count / totalCount) * totalHeight;\n        } else {\n            nextCatHeight = 0;\n        }\n\n        nextCat = {\n            key: nextCatModel.valueInds[0],\n            model: nextCatModel,\n            width: dimWidth,\n            height: nextCatHeight,\n            y: nextCatModel.dragY !== null ? nextCatModel.dragY : nextCatY,\n            bands: [],\n            parcatsViewModel: parcatsViewModel\n        };\n\n        nextCatY = nextCatY + nextCatHeight + catSpacing;\n        categories.push(nextCat);\n    }\n\n    return {\n        key: dimensionModel.dimensionInd,\n        x: dimensionModel.dragX !== null ? dimensionModel.dragX : dimX,\n        y: 0,\n        width: dimWidth,\n        model: dimensionModel,\n        categories: categories,\n        parcatsViewModel: parcatsViewModel,\n        dragCategoryDisplayInd: null,\n        dragDimensionDisplayInd: null,\n        initialDragDimensionDisplayInds: null,\n        initialDragCategoryDisplayInds: null,\n        dragHasMoved: null,\n        potentialClickBand: null\n    };\n}\n\n// JSDoc typedefs\n// ==============\n/**\n * @typedef {Object} Layout\n *  Object containing svg layout information\n *\n * @property {Number} width (pixels)\n *  Usable width for Figure (after margins are removed)\n * @property {Number} height (pixels)\n *  Usable height for Figure (after margins are removed)\n * @property {Margin} margin\n *  Margin around the Figure (pixels)\n */\n\n/**\n * @typedef {Object} Margin\n *  Object containing padding information in pixels\n *\n * @property {Number} t\n *  Top margin\n * @property {Number} r\n *  Right margin\n * @property {Number} b\n *  Bottom margin\n * @property {Number} l\n *  Left margin\n */\n\n/**\n * @typedef {Object} Font\n *  Object containing font information\n *\n * @property {Number} size: Font size\n * @property {String} color: Font color\n * @property {String} family: Font family\n */\n\n/**\n * @typedef {Object} ParcatsViewModel\n *  Object containing calculated parcats view information\n *\n *  These are quantities that require Layout information to calculate\n * @property key\n *  Unique key for this model\n * @property {ParcatsModel} model\n *  Source parcats model\n * @property {Array.<DimensionViewModel>} dimensions\n *  Array of dimension view models\n * @property {Number} width\n *  Width for this trace (pixels)\n * @property {Number} height\n *  Height for this trace (pixels)\n * @property {Number} x\n *  X position of this trace with respect to the Figure (pixels)\n * @property {Number} y\n *  Y position of this trace with respect to the Figure (pixels)\n * @property {String} hoveron\n *  Hover interaction mode. One of: 'category', 'color', or 'dimension'\n * @property {Array.<String>} hoverinfoItems\n *  Info to display on hover. Array with a combination of 'counts' and/or 'probabilities', or 'none', or 'skip'\n * @property {String} arrangement\n *  Category arrangement. One of: 'perpendicular', 'freeform', or 'fixed'\n * @property {Boolean} bundlecolors\n *  Whether paths should be sorted so that like colors are bundled together as they pass through categories\n * @property {String} sortpaths\n *  If 'forward' then sort paths based on dimensions from left to right. If 'backward' sort based on dimensions\n *  from right to left\n * @property {Font} labelfont\n *  Font for the dimension labels\n * @property {Font} categorylabelfont\n *  Font for the category labels\n * @property {String} pathShape\n *  The shape of the paths. Either 'linear' or 'hspline'.\n * @property {DimensionViewModel|null} dragDimension\n *  Dimension currently being dragged. Null if no drag in progress\n * @property {Margin} margin\n *  Margin around the Figure\n * @property {Object} graphDiv\n *  Top-level graph div element\n * @property {Object} traceSelection\n *  D3 selection of this view models trace group element\n * @property {Object} pathSelection\n *  D3 selection of this view models path elements\n * @property {Object} dimensionSelection\n *  D3 selection of this view models dimension group element\n */\n\n/**\n * @typedef {Object} DimensionViewModel\n *  Object containing calculated parcats dimension view information\n *\n *  These are quantities that require Layout information to calculate\n * @property key\n *  Unique key for this model\n * @property {DimensionModel} model\n *  Source dimension model\n * @property {Number} x\n *  X position of the center of this dimension with respect to the Figure (pixels)\n * @property {Number} y\n *  Y position of the top of this dimension with respect to the Figure (pixels)\n * @property {Number} width\n *  Width of categories in this dimension (pixels)\n * @property {ParcatsViewModel} parcatsViewModel\n *  The parent trace's view model\n * @property {Array.<CategoryViewModel>} categories\n *  Dimensions category view models\n * @property {Number|null} dragCategoryDisplayInd\n *  Display index of category currently being dragged. null if no category is being dragged\n * @property {Number|null} dragDimensionDisplayInd\n *  Display index of the dimension being dragged. null if no dimension is being dragged\n * @property {Array.<Number>|null} initialDragDimensionDisplayInds\n *  Dimensions display indexes at the beginning of the current drag. null if no dimension is being dragged\n * @property {Array.<Number>|null} initialDragCategoryDisplayInds\n *  Category display indexes for the at the beginning of the current drag. null if no category is being dragged\n * @property {HTMLElement} potentialClickBand\n *  Band under mouse when current drag began. If no drag movement takes place then a click will be emitted for this\n *  band. Null if not drag in progress.\n * @property {Boolean} dragHasMoved\n *  True if there is an active drag and the drag has moved. If drag doesn't move before being ended then\n *  this may be interpreted as a click. Null if no drag in progress\n */\n\n/**\n * @typedef {Object} CategoryViewModel\n *  Object containing calculated parcats category view information\n *\n *  These are quantities that require Layout information to calculate\n * @property key\n *  Unique key for this model\n * @property {CategoryModel} model\n *  Source category model\n * @property {Number} width\n *  Width for this category (pixels)\n * @property {Number} height\n *  Height for this category (pixels)\n * @property {Number} y\n *  Y position of this cateogry with respect to the Figure (pixels)\n * @property {Array.<CategoryBandViewModel>} bands\n *  Array of color bands inside the category\n * @property {ParcatsViewModel} parcatsViewModel\n *  The parent trace's view model\n */\n\n/**\n * @typedef {Object} CategoryBandViewModel\n *  Object containing calculated category band information. A category band is a region inside a category covering\n *  paths of a single color\n *\n * @property key\n *  Unique key for this model\n * @property color\n *  Band color\n * @property rawColor\n *  Raw color value for band\n * @property {Number} width\n *  Band width\n * @property {Number} height\n *  Band height\n * @property {Number} y\n *  Y position of top of the band with respect to the category\n * @property {Number} count\n *  The number of samples represented by the band\n * @property {CategoryViewModel} categoryViewModel\n *  The parent categorie's view model\n * @property {ParcatsViewModel} parcatsViewModel\n *  The parent trace's view model\n */\n\n/**\n * @typedef {Object} PathViewModel\n *  Object containing calculated parcats path view information\n *\n *  These are quantities that require Layout information to calculate\n * @property key\n *  Unique key for this model\n * @property {PathModel} model\n *  Source path model\n * @property {Number} height\n *  Height of this path (pixels)\n * @property {Array.<Number>} leftXs\n *  The x position of the left edge of each display dimension\n * @property {Array.<Number>} topYs\n *  The y position of the top of the path for each display dimension\n * @property {Array.<Number>} dimWidths\n *  The width of each display dimension\n * @property {String} svgD\n *  SVG path \"d\" attribute string\n * @property {ParcatsViewModel} parcatsViewModel\n *  The parent trace's view model\n */\n"],"mappings":"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rN,KAAK,GAAG8D,UAAU,GAAIiI,WAAW;IACnE,CAAC,MAAM;MACHqB,aAAa,GAAG,CAAC;IACrB;IAEAE,OAAO,GAAG;MACN7T,GAAG,EAAE4T,YAAY,CAACjM,SAAS,CAAC,CAAC,CAAC;MAC9BlH,KAAK,EAAEmT,YAAY;MACnB/R,KAAK,EAAEsR,QAAQ;MACfrR,MAAM,EAAE6R,aAAa;MACrBvT,CAAC,EAAEwT,YAAY,CAAC7H,KAAK,KAAK,IAAI,GAAG6H,YAAY,CAAC7H,KAAK,GAAG+H,QAAQ;MAC9D5R,KAAK,EAAE,EAAE;MACTK,gBAAgB,EAAEA;IACtB,CAAC;IAEDuR,QAAQ,GAAGA,QAAQ,GAAGH,aAAa,GAAGD,UAAU;IAChD/R,UAAU,CAAC2E,IAAI,CAACuN,OAAO,CAAC;EAC5B;EAEA,OAAO;IACH7T,GAAG,EAAE2J,cAAc,CAACtG,YAAY;IAChClD,CAAC,EAAEwJ,cAAc,CAACiD,KAAK,KAAK,IAAI,GAAGjD,cAAc,CAACiD,KAAK,GAAG2G,IAAI;IAC9DnT,CAAC,EAAE,CAAC;IACJyB,KAAK,EAAEsR,QAAQ;IACf1S,KAAK,EAAEkJ,cAAc;IACrBhI,UAAU,EAAEA,UAAU;IACtBY,gBAAgB,EAAEA,gBAAgB;IAClCmJ,sBAAsB,EAAE,IAAI;IAC5BH,uBAAuB,EAAE,IAAI;IAC7BC,+BAA+B,EAAE,IAAI;IACrCK,8BAA8B,EAAE,IAAI;IACpCJ,YAAY,EAAE,IAAI;IAClBO,kBAAkB,EAAE;EACxB,CAAC;AACL;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA"},"metadata":{},"sourceType":"script","externalDependencies":[]}